
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>larch.dataset &#8212; PRE-RELEASE DEV DOCS</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/larch-book.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <link rel="shortcut icon" href="../../_static/larch_favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    
      
      <link rel="icon" sizes="32x32" href="../../_static/img/larch_favicon.png">
      
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/larch-logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">PRE-RELEASE DEV DOCS</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search these docs..." aria-label="Search these docs..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Users Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../installation.html">
   Installing Larch
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../user-guide/choice-models.html">
   Choice Models
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../user-guide/data-fundamentals.html">
     Data Fundamentals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../user-guide/linear-funcs.html">
     Linear Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../user-guide/machine-learning.html">
     Machine Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../bibliography.html">
   References
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  API Reference
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../api/~data.html">
   Data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/dataset.html">
     Dataset
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.html">
       larch.Dataset
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_idca.html">
       larch.Dataset.from_idca
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_idce.html">
       larch.Dataset.from_idce
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_idco.html">
       larch.Dataset.from_idco
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.construct.html">
       larch.Dataset.construct
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_table.html">
       larch.Dataset.from_table
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_omx.html">
       larch.Dataset.from_omx
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_omx_3d.html">
       larch.Dataset.from_omx_3d
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_zarr.html">
       larch.Dataset.from_zarr
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_named_objects.html">
       larch.Dataset.from_named_objects
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.n_cases.html">
       larch.Dataset.n_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.n_alts.html">
       larch.Dataset.n_alts
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.CASEID.html">
       larch.Dataset.CASEID
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.ALTID.html">
       larch.Dataset.ALTID
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.alts_mapping.html">
       larch.Dataset.alts_mapping
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.dims.html">
       larch.Dataset.dims
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.sizes.html">
       larch.Dataset.sizes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.data_vars.html">
       larch.Dataset.data_vars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.coords.html">
       larch.Dataset.coords
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.attrs.html">
       larch.Dataset.attrs
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.encoding.html">
       larch.Dataset.encoding
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.indexes.html">
       larch.Dataset.indexes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.chunks.html">
       larch.Dataset.chunks
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.chunksizes.html">
       larch.Dataset.chunksizes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.nbytes.html">
       larch.Dataset.nbytes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.caseids.html">
       larch.Dataset.caseids
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.dissolve_zero_variance.html">
       larch.Dataset.dissolve_zero_variance
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.query_cases.html">
       larch.Dataset.query_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.set_altnames.html">
       larch.Dataset.set_altnames
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.set_dtypes.html">
       larch.Dataset.set_dtypes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.setup_flow.html">
       larch.Dataset.setup_flow
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.get_expr.html">
       larch.Dataset.get_expr
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/datatree.html">
     DataTree
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.html">
       larch.DataTree
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.root_node_name.html">
       larch.DataTree.root_node_name
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.subspaces.html">
       larch.DataTree.subspaces
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.relationships_are_digitized.html">
       larch.DataTree.relationships_are_digitized
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.n_cases.html">
       larch.DataTree.n_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.n_alts.html">
       larch.DataTree.n_alts
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.CASEID.html">
       larch.DataTree.CASEID
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.ALTID.html">
       larch.DataTree.ALTID
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.add_dataset.html">
       larch.DataTree.add_dataset
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.add_relationship.html">
       larch.DataTree.add_relationship
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.digitize_relationships.html">
       larch.DataTree.digitize_relationships
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.query_cases.html">
       larch.DataTree.query_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.replace_datasets.html">
       larch.DataTree.replace_datasets
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.setup_flow.html">
       larch.DataTree.setup_flow
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/dataframes.html">
     DataFrames
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataFrames.html">
       larch.DataFrames
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../api/~models.html">
   Models
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/model.html">
     Model
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.html">
       larch.numba.Model
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.datatree.html">
       larch.numba.Model.datatree
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.dataset.html">
       larch.numba.Model.dataset
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.n_cases.html">
       larch.numba.Model.n_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.choice_ca_var.html">
       larch.numba.Model.choice_ca_var
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.choice_co_vars.html">
       larch.numba.Model.choice_co_vars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.choice_co_code.html">
       larch.numba.Model.choice_co_code
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.availability_ca_var.html">
       larch.numba.Model.availability_ca_var
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.availability_co_vars.html">
       larch.numba.Model.availability_co_vars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.utility_ca.html">
       larch.numba.Model.utility_ca
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.utility_co.html">
       larch.numba.Model.utility_co
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.quantity_ca.html">
       larch.numba.Model.quantity_ca
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.pf.html">
       larch.numba.Model.pf
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.most_recent_estimation_result.html">
       larch.numba.Model.most_recent_estimation_result
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.possible_overspecification.html">
       larch.numba.Model.possible_overspecification
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.set_values.html">
       larch.numba.Model.set_values
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.lock_value.html">
       larch.numba.Model.lock_value
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.set_cap.html">
       larch.numba.Model.set_cap
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.remove_unused_parameters.html">
       larch.numba.Model.remove_unused_parameters
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.maximize_loglike.html">
       larch.numba.Model.maximize_loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.calculate_parameter_covariance.html">
       larch.numba.Model.calculate_parameter_covariance
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.loglike_nil.html">
       larch.numba.Model.loglike_nil
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.loglike_null.html">
       larch.numba.Model.loglike_null
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.rho_sq_nil.html">
       larch.numba.Model.rho_sq_nil
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.rho_sq_null.html">
       larch.numba.Model.rho_sq_null
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.parameter_summary.html">
       larch.numba.Model.parameter_summary
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.estimation_statistics.html">
       larch.numba.Model.estimation_statistics
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.to_xlsx.html">
       larch.numba.Model.to_xlsx
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.bhhh.html">
       larch.numba.Model.bhhh
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.check_d_loglike.html">
       larch.numba.Model.check_d_loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.d_loglike.html">
       larch.numba.Model.d_loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.d_loglike_casewise.html">
       larch.numba.Model.d_loglike_casewise
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.loglike.html">
       larch.numba.Model.loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.loglike_casewise.html">
       larch.numba.Model.loglike_casewise
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.logsums.html">
       larch.numba.Model.logsums
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.probability.html">
       larch.numba.Model.probability
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.quantity.html">
       larch.numba.Model.quantity
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.total_weight.html">
       larch.numba.Model.total_weight
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.utility.html">
       larch.numba.Model.utility
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/linear.html">
     Linear Functions
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/nesting.html">
     NestingTree
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
    <label for="toctree-checkbox-8">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.html">
       larch.model.tree.NestingTree
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.new_node.html">
       larch.model.tree.NestingTree.new_node
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.add_node.html">
       larch.model.tree.NestingTree.add_node
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.remove_node.html">
       larch.model.tree.NestingTree.remove_node
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.add_edge.html">
       larch.model.tree.NestingTree.add_edge
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.remove_edge.html">
       larch.model.tree.NestingTree.remove_edge
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/modelgroup.html">
     ModelGroup
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.html">
       larch.model.model_group.ModelGroup
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.n_cases.html">
       larch.model.model_group.ModelGroup.n_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.set_values.html">
       larch.model.model_group.ModelGroup.set_values
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.total_weight.html">
       larch.model.model_group.ModelGroup.total_weight
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.loglike.html">
       larch.model.model_group.ModelGroup.loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.loglike2.html">
       larch.model.model_group.ModelGroup.loglike2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.to_xlsx.html">
       larch.model.model_group.ModelGroup.to_xlsx
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Examples
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/mtc.html">
   MTC Mode Choice
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/000_mtc_data.html">
     MTC Work Mode Choice Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/001_mnl.html">
     1: MTC MNL Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/002_mtc.html">
     2: MTC MNL Mode Choice, Motorized
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/017A_mnl_segmented.html">
     17a: Market Segmentatation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/017_mnl_final.html">
     17: MTC Expanded MNL Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/022-nl.html">
     22: MTC Motorized and Non-Motorized Nested Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/028-nl.html">
     28: MTC Motorized - Shared Ride - Non-Motorized Nested Mode Choice
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/swissmetro.html">
   Swissmetro
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/101_swissmetro_mnl.html">
     101: Swissmetro MNL Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/102-swissmetro-weighted.html">
     102: Swissmetro Weighted MNL Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/109-swissmetro-nl.html">
     109: Swissmetro Nested Logit Mode Choice
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/exampville.html">
   Exampville
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/200_exampville.html">
     200: Exampville Simulated Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/201_exville_mode_choice.html">
     201: Exampville Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/202_exville_mc_logsums.html">
     202: Exampville Mode Choice Logsums
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/203_exville_dest.html">
     203: Exampville Destination Choice
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/itinerary.html">
   Itinerary Choice
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/300_itinerary.html">
     300: Itinerary Choice Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/301_itin_mnl.html">
     301: Itinerary Choice using MNL
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/legacy.html">
   Legacy Examples
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../example/legacy/mtc.html">
     MTC Mode Choice Examples
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
    <label for="toctree-checkbox-15">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/000_mtc_data.html">
       MTC Work Mode Choice Data
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/001.mtc.html">
       1: MTC MNL Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/002_mtc.html">
       2: MTC MNL Mode Choice, Motorized
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/003_mtc.html">
       3: MTC MNL Mode Choice, Zeroed Shared
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/005_mtc.html">
       5: MTC MNL Mode Choice, Motorized Travel Time
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/006_mtc.html">
       6: MTC MNL Mode Choice, Motorized Times
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/007_mtc.html">
       7: MTC MNL Mode Choice, Diminishing OVTT by Distance
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/008_mtc.html">
       8: MTC MNL Mode Choice, TTR = 2.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/009_mtc.html">
       9: MTC MNL Mode Choice, TTR = 4.0
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/010_mtc.html">
       10: MTC MNL Mode Choice, Autos per Household
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/011_mtc.html">
       11: MTC MNL Mode Choice, Vehicle by Worker
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/012_mtc.html">
       12: MTC MNL Mode Choice, Autos per Adult
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/013_mtc.html">
       13: MTC MNL Mode Choice, CBD
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/014_mtc.html">
       14: MTC MNL Mode Choice, Work Zone Density
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/015_mtc.html">
       15: MTC MNL Mode Choice, CBD and Work Zone Density
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/016_mtc.html">
       16: MTC MNL Mode Choice, Cost by Income
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017A_mtc.html">
       17A: MTC MNL Mode Choice, Segmented for 1 or fewer cars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017B_mtc.html">
       17B: MTC MNL Mode Choice, Segmented for 2 or more cars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017C_mtc.html">
       17C: MTC MNL Mode Choice, Segmented for Males
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017D_mtc.html">
       17D: MTC MNL Mode Choice, Segmented for Females
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017_mtc.html">
       17: MTC Expanded MNL Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/018_mtc.html">
       18: MTC Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/019_mtc.html">
       19: MTC Private Auto Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/020_mtc.html">
       20: MTC Shared Ride Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/021_mtc.html">
       21: MTC Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/022_mtc.html">
       22: MTC Motorized and Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/023_mtc.html">
       23W: MTC Private Auto - Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/024_mtc.html">
       23W: MTC Shared Ride - Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/025_mtc.html">
       25: MTC Private Auto - Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/026_mtc.html">
       26: MTC Shared Ride - Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/027_mtc.html">
       27: MTC Shared Ride - Private Auto Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/028_mtc.html">
       28: MTC Motorized - Shared Ride - Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/029_mtc.html">
       29: MTC Motorized - Shared Ride - Private Auto Nested Mode Choice
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../example/legacy/swissmetro.html">
     Swissmetro Examples
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
    <label for="toctree-checkbox-16">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/101_mnl.html">
       101: Swissmetro MNL Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/102_mnl_weighted.html">
       102: Swissmetro Weighted MNL Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/107_latent_class.html">
       107: Latent Class Models
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/109_nl.html">
       109: Swissmetro Nested Logit Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/111_cnl.html">
       111: Swissmetro Cross-Nested Logit Mode Choice
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../example/legacy/itinerary.html">
     Itinerary Choice Examples
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
    <label for="toctree-checkbox-17">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/300L_itinerary.html">
       300L: Itinerary Choice Data
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/301_itin_mnl.html">
       301: Itinerary Choice using MNL
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/302_itin_nl.html">
       302: Itinerary Choice using Simple Nested Logit
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/jpn--/larch"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/jpn--/larch/issues/new?title=Issue%20on%20page%20%2F_modules/larch/dataset.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            
              <div>
                
  <h1>Source code for larch.dataset</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">xarray.core</span> <span class="kn">import</span> <span class="n">dtypes</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">DefaultDict</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Hashable</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sharrow</span> <span class="kn">import</span> <span class="n">Dataset</span> <span class="k">as</span> <span class="n">_sharrow_Dataset</span>
    <span class="kn">from</span> <span class="nn">sharrow</span> <span class="kn">import</span> <span class="n">DataArray</span> <span class="k">as</span> <span class="n">_sharrow_DataArray</span>
    <span class="kn">from</span> <span class="nn">sharrow</span> <span class="kn">import</span> <span class="n">DataTree</span> <span class="k">as</span> <span class="n">_sharrow_DataTree</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;larch.dataset requires the sharrow library&quot;</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">_noclass</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">_sharrow_Dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span>
    <span class="n">_sharrow_DataArray</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span>
    <span class="n">_sharrow_DataTree</span> <span class="o">=</span> <span class="n">_noclass</span>

<span class="kn">from</span> <span class="nn">.dim_names</span> <span class="kn">import</span> <span class="n">CASEID</span> <span class="k">as</span> <span class="n">_CASEID</span><span class="p">,</span> <span class="n">ALTID</span> <span class="k">as</span> <span class="n">_ALTID</span><span class="p">,</span> <span class="n">CASEALT</span> <span class="k">as</span> <span class="n">_CASEALT</span><span class="p">,</span> <span class="n">ALTIDX</span> <span class="k">as</span> <span class="n">_ALTIDX</span><span class="p">,</span> <span class="n">CASEPTR</span> <span class="k">as</span> <span class="n">_CASEPTR</span>

<span class="k">class</span> <span class="nc">DataArray</span><span class="p">(</span><span class="n">_sharrow_DataArray</span><span class="p">):</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">caseid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">altid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">caseid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">caseid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span> <span class="o">=</span> <span class="n">caseid</span>
        <span class="k">if</span> <span class="n">altid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">altid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span> <span class="o">=</span> <span class="n">altid</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">zeros</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a dataset filled with zeros.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coords : Tuple[array-like]</span>
<span class="sd">            A sequence of coordinate vectors.  Ideally each should have a</span>
<span class="sd">            `name` attribute that names a dimension, otherwise placeholder</span>
<span class="sd">            names are used.</span>
<span class="sd">        dtype : dtype, default np.float64</span>
<span class="sd">            dtype of the new array. If omitted, it defaults to np.float64.</span>
<span class="sd">        name : str or None, optional</span>
<span class="sd">            Name of this array.</span>
<span class="sd">        attrs : dict_like or None, optional</span>
<span class="sd">            Attributes to assign to the new instance. By default, an empty</span>
<span class="sd">            attribute dictionary is initialized.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataArray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">coo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;dim_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">coo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">coo</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_zarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write DataArray contents to a zarr store.</span>

<span class="sd">        All parameters are passed directly to :py:meth:`xarray.Dataset.to_zarr`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Only xarray.Dataset objects can be written to netCDF files, so</span>
<span class="sd">        the xarray.DataArray is converted to a xarray.Dataset object</span>
<span class="sd">        containing a single variable. If the DataArray has no name, or if the</span>
<span class="sd">        name is the same as a coordinate name, then it is given the name</span>
<span class="sd">        ``&quot;__xarray_dataarray_variable__&quot;``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Dataset.to_zarr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">xarray.backends.api</span> <span class="kn">import</span> <span class="n">DATAARRAY_VARIABLE</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If no name is set then use a generic xarray name</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">DATAARRAY_VARIABLE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No problems with the name - so we&#39;re fine!</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">store</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
                <span class="kn">import</span> <span class="nn">zarr</span>
                <span class="k">with</span> <span class="n">zarr</span><span class="o">.</span><span class="n">ZipStore</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zstore</span><span class="p">:</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="n">zstore</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_zarr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot infer name to load&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">CASEID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;no defined CASEID&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_CASEID</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@CASEID</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">CASEID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim_name</span><span class="si">}</span><span class="s2"> not in dims&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEID</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ALTID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_ALTID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;no defined ALTID&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_ALTID</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@ALTID</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ALTID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_ALTID</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;missing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="si">!r}</span><span class="s2"> among dims </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_alts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span><span class="p">)]</span>
        <span class="k">if</span> <span class="s1">&#39;n_alts&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;n_alts&#39;</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no n_alts set&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alts_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dict[int,str] : Mapping of alternative codes to names&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;alt_names&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;alt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">html</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;sharrow.DataArray&quot;</span><span class="p">,</span> <span class="s2">&quot;larch.DataArray&quot;</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;xarray.DataArray&quot;</span><span class="p">,</span> <span class="s2">&quot;larch.DataArray&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">html</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;sharrow.DataArray&quot;</span><span class="p">,</span> <span class="s2">&quot;larch.DataArray&quot;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;xarray.DataArray&quot;</span><span class="p">,</span> <span class="s2">&quot;larch.DataArray&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">value_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of times each unique value appears in the array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index_name : str, default &#39;index&#39;</span>
<span class="sd">            Name of index dimension in result.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataArray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">index_name</span><span class="p">:</span><span class="n">values</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array whose values are limited to ``[min, max]``.</span>
<span class="sd">        At least one of max or min must be given.</span>

<span class="sd">        Refer to `numpy.clip` for full documentation.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        numpy.clip : equivalent function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">return</span> <span class="n">out</span>


<div class="viewcode-block" id="Dataset"><a class="viewcode-back" href="../../api/generated/larch.Dataset.html#larch.Dataset">[docs]</a><span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">_sharrow_Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A xarray.Dataset extended interface for use with Larch.</span>

<span class="sd">    A Dataset consists of variables, coordinates and attributes which</span>
<span class="sd">    together form a self describing dataset.</span>

<span class="sd">    Dataset implements the mapping interface with keys given by variable</span>
<span class="sd">    names and values given by DataArray objects for each variable name.</span>

<span class="sd">    One dimensional variables with name equal to their dimension are</span>
<span class="sd">    index coordinates used for label based indexing.</span>

<span class="sd">    For Larch, one dimension of each Dataset must typiccally be named &#39;_caseid_&#39;,</span>
<span class="sd">    and this dimension is used to identify the individual discrete choice</span>
<span class="sd">    observations or simulations in the data. The `caseid` argument can be</span>
<span class="sd">    used to set an existing dimension as &#39;_caseid_&#39; on Dataset construction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_vars : dict-like, optional</span>
<span class="sd">        A mapping from variable names to :py:class:`~xarray.DataArray`</span>
<span class="sd">        objects, :py:class:`~xarray.Variable` objects or to tuples of</span>
<span class="sd">        the form ``(dims, data[, attrs])`` which can be used as</span>
<span class="sd">        arguments to create a new ``Variable``. Each dimension must</span>
<span class="sd">        have the same length in all variables in which it appears.</span>

<span class="sd">        The following notations are accepted:</span>

<span class="sd">        - mapping {var name: DataArray}</span>
<span class="sd">        - mapping {var name: Variable}</span>
<span class="sd">        - mapping {var name: (dimension name, array-like)}</span>
<span class="sd">        - mapping {var name: (tuple of dimension names, array-like)}</span>
<span class="sd">        - mapping {dimension name: array-like}</span>
<span class="sd">          (it will be automatically moved to coords, see below)</span>

<span class="sd">        Each dimension must have the same length in all variables in</span>
<span class="sd">        which it appears.</span>

<span class="sd">    coords : dict-like, optional</span>
<span class="sd">        Another mapping in similar form as the `data_vars` argument,</span>
<span class="sd">        except the each item is saved on the dataset as a &quot;coordinate&quot;.</span>
<span class="sd">        These variables have an associated meaning: they describe</span>
<span class="sd">        constant/fixed/independent quantities, unlike the</span>
<span class="sd">        varying/measured/dependent quantities that belong in</span>
<span class="sd">        `variables`. Coordinates values may be given by 1-dimensional</span>
<span class="sd">        arrays or scalars, in which case `dims` do not need to be</span>
<span class="sd">        supplied: 1D arrays will be assumed to give index values along</span>
<span class="sd">        the dimension with the same name.</span>

<span class="sd">        The following notations are accepted:</span>

<span class="sd">        - mapping {coord name: DataArray}</span>
<span class="sd">        - mapping {coord name: Variable}</span>
<span class="sd">        - mapping {coord name: (dimension name, array-like)}</span>
<span class="sd">        - mapping {coord name: (tuple of dimension names, array-like)}</span>
<span class="sd">        - mapping {dimension name: array-like}</span>
<span class="sd">          (the dimension name is implicitly set to be the same as the</span>
<span class="sd">          coord name)</span>

<span class="sd">        The last notation implies that the coord name is the same as</span>
<span class="sd">        the dimension name.</span>

<span class="sd">    attrs : dict-like, optional</span>
<span class="sd">        Global attributes to save on this dataset.</span>

<span class="sd">    caseid : str, optional, keyword only</span>
<span class="sd">        This named dimension will be marked as the &#39;_caseid_&#39; dimension.</span>

<span class="sd">    alts : str or Mapping or array-like, keyword only</span>
<span class="sd">        If given as a str, this named dimension will be marked as the</span>
<span class="sd">        &#39;_altid_&#39; dimension.  Otherwise, give a Mapping that defines</span>
<span class="sd">        alternative names and (integer) codes or an array of codes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_flow_library&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">caseid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;sharrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NEW INSTANCE </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__initialize_for_larch</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">caseid</span><span class="p">,</span> <span class="n">alts</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__initialize_for_larch</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">caseid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj : Dataset</span>
<span class="sd">            The dataaset being initialized.</span>
<span class="sd">        caseid : str, optional</span>
<span class="sd">            The name of a dimension referencing cases.</span>
<span class="sd">        alts : Mapping or str or array-like, optional</span>
<span class="sd">            If given as a mapping, links alternative codes to names.</span>
<span class="sd">            A string names a dimension that defines the alternatives.</span>
<span class="sd">            An array or list of integers gives codes for the alternatives,</span>
<span class="sd">            which are otherwise unnamed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_flow_library</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">caseid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">caseid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no dim named &#39;</span><span class="si">{</span><span class="n">caseid</span><span class="si">}</span><span class="s2">&#39; to make into </span><span class="si">{</span><span class="n">_CASEID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEID</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseid</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alts</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">alts_dim_name</span> <span class="o">=</span> <span class="n">alts</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">alts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;_altid_&#39;</span>
            <span class="n">alts_k</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span>
                <span class="n">alts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">alts_dim_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">alts_v</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span>
                <span class="n">alts</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">alts_dim_name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alts</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">alts_dim_name</span> <span class="o">=</span> <span class="s1">&#39;_altid_&#39;</span>
            <span class="n">alts_k</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">alts</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">dims</span><span class="o">=</span><span class="n">alts_dim_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">alts_v</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">alts</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dims</span><span class="o">=</span><span class="n">alts_dim_name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alts_dim_name</span> <span class="o">=</span> <span class="n">alts</span>
            <span class="n">alts_k</span> <span class="o">=</span> <span class="n">alts_v</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">alts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alts_dim_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">alts_k</span> <span class="o">=</span> <span class="n">alts_v</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alts_dim_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">alts</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;_altid_&#39;</span><span class="p">)</span>
            <span class="n">alts_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">alts_k</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">alts_dim_name</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_ALTID</span><span class="p">]</span> <span class="o">=</span> <span class="n">alts_dim_name</span>
        <span class="k">if</span> <span class="n">alts_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">alts_v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">alts_k</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">alts_dim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">alts_v</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;alt_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alts_k</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">alts_dim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">alts_k</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;alt_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alts_v</span>
        <span class="k">elif</span> <span class="n">alts_v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">alts_dim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">alts_v</span>
        <span class="k">return</span> <span class="n">obj</span>

<div class="viewcode-block" id="Dataset.construct"><a class="viewcode-back" href="../../api/generated/larch.Dataset.construct.html#larch.Dataset.construct">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">caseid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A generic constructor for creating Datasets from various similar objects.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : pandas.DataFrame, pyarrow.Table, xarray.Dataset, or Sequence[str]</span>
<span class="sd">            The source from which to create a Dataset.  DataFrames and Tables</span>
<span class="sd">            are converted to Datasets that have one dimension (the rows) and</span>
<span class="sd">            seperate variables for each of the columns.  A list of strings</span>
<span class="sd">            creates a dataset with those named empty variables.</span>
<span class="sd">        caseid : str, optional</span>
<span class="sd">            The name of a dimension referencing cases.</span>
<span class="sd">        alts : Mapping or str or array-like, optional</span>
<span class="sd">            If given as a mapping, links alternative codes to names.</span>
<span class="sd">            A string names a dimension that defines the alternatives.</span>
<span class="sd">            An array or list of integers gives codes for the alternatives,</span>
<span class="sd">            which are otherwise unnamed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__initialize_for_larch</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">caseid</span><span class="p">,</span> <span class="n">alts</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_sparse_data_from_dataframe_gcxs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">arrays</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="n">dims</span><span class="p">:</span> <span class="nb">tuple</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sparse</span> <span class="kn">import</span> <span class="n">COO</span><span class="p">,</span> <span class="n">GCXS</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">codes</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">is_sorted</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">is_monotonic_increasing</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lev</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">is_sorted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">,)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sorted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;index must be sorted&quot;</span><span class="p">)</span>

        <span class="n">template_data</span> <span class="o">=</span> <span class="n">COO</span><span class="p">(</span>
            <span class="n">coords</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)),</span>
            <span class="n">shape</span><span class="p">,</span>
            <span class="n">has_duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="nb">sorted</span><span class="o">=</span><span class="n">is_sorted</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">template_gcxs</span> <span class="o">=</span> <span class="n">GCXS</span><span class="p">(</span><span class="n">template_data</span><span class="p">,</span> <span class="n">compressed_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">:</span>
            <span class="c1"># In virtually all real use cases, the sparse array will now have</span>
            <span class="c1"># missing values and needs a fill_value. For consistency, don&#39;t</span>
            <span class="c1"># special case the rare exceptions (e.g., dtype=int without a</span>
            <span class="c1"># MultiIndex).</span>
            <span class="n">dtype</span><span class="p">,</span> <span class="n">fill_value</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">maybe_promote</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">GCXS</span><span class="p">(</span>
                <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">template_gcxs</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">template_gcxs</span><span class="o">.</span><span class="n">indptr</span><span class="p">),</span>
                <span class="n">shape</span><span class="o">=</span><span class="n">template_gcxs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">compressed_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span>
                <span class="n">prune</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="Dataset.__init__"><a class="viewcode-back" href="../../api/generated/larch.Dataset.html#larch.Dataset.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span> <span class="c1"># init for superclass happens inside __new__</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">CASEID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;no defined CASEID&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_CASEID</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@CASEID</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">CASEID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim_name</span><span class="si">}</span><span class="s2"> not in dims&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEID</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ALTID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_ALTID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;no defined ALTID&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_ALTID</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@ALTID</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ALTID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_ALTID</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alts_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dict[int,str] : Mapping of alternative codes to names&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;alt_names&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;alt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;missing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="si">!r}</span><span class="s2"> among dims </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_alts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;n_alts&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;n_alts&#39;</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no n_alts set&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">CASEALT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str : The _casealt_ dimension of this Dataset, if defined.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEALT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@CASEALT</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">CASEALT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEALT</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ALTIDX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str : The _alt_idx_ dimension of this Dataset, if defined.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_ALTIDX</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@ALTIDX</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ALTIDX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_ALTIDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">CASEPTR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str : The _caseptr_ dimension of this Dataset, if defined.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEPTR</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@CASEPTR</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">CASEPTR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEPTR</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_name</span>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">html</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;sharrow.Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;larch.Dataset&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">html</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;sharrow.Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;larch.Dataset&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># change attrs from xr.DataArray to larch.DataArray</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_ALTID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEID</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_ALTID</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">result</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">DataArray</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># change items from xr.DataArray to larch.DataArray</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_ALTID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEID</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_ALTID</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">result</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">DataArray</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="Dataset.get_expr"><a class="viewcode-back" href="../../api/generated/larch.Dataset.get_expr.html#larch.Dataset.get_expr">[docs]</a>    <span class="k">def</span> <span class="nf">get_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access or evaluate an expression.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        expression : str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataArray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">expression</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_flow_library</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_flow</span><span class="p">({</span><span class="n">expression</span><span class="p">:</span> <span class="n">expression</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expression</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flow_library</span><span class="p">:</span>
                    <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flow_library</span><span class="p">[</span><span class="n">expression</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_flow</span><span class="p">({</span><span class="n">expression</span><span class="p">:</span> <span class="n">expression</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_flow_library</span><span class="p">[</span><span class="n">expression</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flow</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root_dataset</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">flow</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_tree</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">load_dataarray</span><span class="p">()</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">expressions</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


    <span class="k">def</span> <span class="nf">to_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">float_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.numba.data_arrays</span> <span class="kn">import</span> <span class="n">DataArrays</span>
        <span class="kn">from</span> <span class="nn">.numba.cascading</span> <span class="kn">import</span> <span class="n">array_av_cascade</span><span class="p">,</span> <span class="n">array_ch_cascade</span>

        <span class="k">if</span> <span class="s1">&#39;co&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">co</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;co&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">float_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cases</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float_dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;ca&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">ca</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ca&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">float_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_alts</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float_dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;ce_data&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">ce_data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ce_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">float_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ce_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float_dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALTIDX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ce_altidx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTIDX</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ce_altidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CASEPTR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ce_caseptr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">sliding_window_view</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEPTR</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">2</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ce_caseptr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cases</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;wt&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">wt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;wt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">float_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cases</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float_dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;ch&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">array_ch_cascade</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cases</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float_dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;av&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">av</span> <span class="o">=</span> <span class="n">array_av_cascade</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;av&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cases</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DataArrays</span><span class="p">(</span>
            <span class="n">ch</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="n">wt</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ce_data</span><span class="p">,</span> <span class="n">ce_altidx</span><span class="p">,</span> <span class="n">ce_caseptr</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">error_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">warn_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">error_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;- There is no dimensions named `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="si">}</span><span class="s2">`. &quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">warn_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;- There is no dimensions named `_altid_`. &quot;</span>
            <span class="p">)</span>
        <span class="n">msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">error_msgs</span><span class="p">:</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ERRORS:&quot;</span><span class="p">)</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">error_msgs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">warn_msgs</span><span class="p">:</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;WARNINGS:&quot;</span><span class="p">)</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">warn_msgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msgs</span>

<div class="viewcode-block" id="Dataset.query_cases"><a class="viewcode-back" href="../../api/generated/larch.Dataset.query_cases.html#larch.Dataset.query_cases">[docs]</a>    <span class="k">def</span> <span class="nf">query_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="s2">&quot;pandas&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new dataset with each array indexed along the CASEID dimension.</span>

<span class="sd">        The indexers are given as strings containing Python expressions to be</span>
<span class="sd">        evaluated against the data variables in the dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query : str</span>
<span class="sd">            Python expressions to be evaluated against the data variables</span>
<span class="sd">            in the dataset. The expressions will be evaluated using the pandas</span>
<span class="sd">            eval() function, and can contain any valid Python expressions but cannot</span>
<span class="sd">            contain any Python statements.</span>
<span class="sd">        parser : {&quot;pandas&quot;, &quot;python&quot;}, default: &quot;pandas&quot;</span>
<span class="sd">            The parser to use to construct the syntax tree from the expression.</span>
<span class="sd">            The default of &#39;pandas&#39; parses code slightly different than standard</span>
<span class="sd">            Python. Alternatively, you can parse an expression using the &#39;python&#39;</span>
<span class="sd">            parser to retain strict Python semantics.</span>
<span class="sd">        engine : {&quot;python&quot;, &quot;numexpr&quot;, None}, default: None</span>
<span class="sd">            The engine used to evaluate the expression. Supported engines are:</span>

<span class="sd">            - None: tries to use numexpr, falls back to python</span>
<span class="sd">            - &quot;numexpr&quot;: evaluates expressions using numexpr</span>
<span class="sd">            - &quot;python&quot;: performs operations as if you had evald in top level python</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        obj : Dataset</span>
<span class="sd">            A new Dataset with the same contents as this dataset, except each</span>
<span class="sd">            array is indexed by the results of the query on the CASEID dimension.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Dataset.isel</span>
<span class="sd">        pandas.eval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">dissolve_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">others</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">]</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">to_series</span><span class="p">()))</span>
        <span class="n">mapper_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">others</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">others</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">others</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">others</span> <span class="o">=</span> <span class="p">[</span><span class="n">others</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">other</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="n">mapper_f</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">other</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="Dataset.dissolve_zero_variance"><a class="viewcode-back" href="../../api/generated/larch.Dataset.dissolve_zero_variance.html#larch.Dataset.dissolve_zero_variance">[docs]</a>    <span class="k">def</span> <span class="nf">dissolve_zero_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;&lt;ALTID&gt;&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dissolve dimension on variables where it has no variance.</span>

<span class="sd">        This method is convenient to convert variables that have</span>
<span class="sd">        been loaded as |idca| or |idce| format into |idco| format where</span>
<span class="sd">        appropriate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dim : str, optional</span>
<span class="sd">            The name of the dimension to potentially dissolve.</span>
<span class="sd">        inplace : bool, default False</span>
<span class="sd">            Whether to dissolve variables in-place.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="s1">&#39;&lt;ALTID&gt;&#39;</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">}:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dissolve</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dissolve</span><span class="p">:</span>
                        <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEALT</span><span class="p">,):</span>
                <span class="n">proposal</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">ce_dissolve_zero_variance</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">CASEPTR</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">assign</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">proposal</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">CASEID</span><span class="p">))})</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="Dataset.set_dtypes"><a class="viewcode-back" href="../../api/generated/larch.Dataset.set_dtypes.html#larch.Dataset.set_dtypes">[docs]</a>    <span class="k">def</span> <span class="nf">set_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the dtypes for the variables in this Dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtypes : Mapping or DataFrame</span>
<span class="sd">            Mapping of names to dtypes, or a DataFrame to infer such a</span>
<span class="sd">            mapping.</span>
<span class="sd">        inplace : bool, default False</span>
<span class="sd">            Whether to convert dtypes inplace.</span>
<span class="sd">        on_error : {&#39;warn&#39;, &#39;raise&#39;, &#39;ignore&#39;}</span>
<span class="sd">            What to do when a type conversion triggers an error.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">dtypes</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">dtypes</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtypes</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s1">&#39;warn&#39;</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err</span><span class="si">!r}</span><span class="s2"> on converting </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s1">&#39;raise&#39;</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="Dataset.set_altnames"><a class="viewcode-back" href="../../api/generated/larch.Dataset.set_altnames.html#larch.Dataset.set_altnames">[docs]</a>    <span class="k">def</span> <span class="nf">set_altnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">altnames</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the alternative names for this Dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        altnames : Mapping or array-like</span>
<span class="sd">            A mapping of (integer) codes to names, or an array or names</span>
<span class="sd">            of the same length and order as the alternatives already</span>
<span class="sd">            defined in this Dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">altnames</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="p">[</span><span class="n">altnames</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">ALTID</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">ALTID</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">altnames</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">altnames</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">altnames</span><span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">ALTID</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;altnames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="Dataset.from_idca"><a class="viewcode-back" href="../../api/generated/larch.Dataset.from_idca.html#larch.Dataset.from_idca">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_idca</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">crack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">altnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avail</span><span class="o">=</span><span class="s1">&#39;_avail_&#39;</span><span class="p">,</span> <span class="n">fill_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a Dataset from an idca-format DataFrame.</span>

<span class="sd">        This method loads the data as dense arrays.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            The input data should be an idca-format or idce-format DataFrame,</span>
<span class="sd">            with the caseid&#39;s and altid&#39;s in a two-level pandas MultiIndex.</span>
<span class="sd">        crack : bool, default True</span>
<span class="sd">            If True, the `dissolve_zero_variance` method is applied before</span>
<span class="sd">            repairing dtypes, to ensure that missing value are handled</span>
<span class="sd">            properly.</span>
<span class="sd">        altnames : Mapping, optional</span>
<span class="sd">            If given as a mapping, links alternative codes to names.</span>
<span class="sd">            An array or list of strings gives names for the alternatives,</span>
<span class="sd">            sorted in the same order as the codes.</span>
<span class="sd">        avail : str, default &#39;_avail_&#39;</span>
<span class="sd">            When the imported data is in idce format (i.e. sparse) then</span>
<span class="sd">            an availability indicator is computed and given this name.</span>
<span class="sd">        fill_missing : scalar or Mapping, optional</span>
<span class="sd">            Fill values to use for missing values when imported data is</span>
<span class="sd">            in idce format (i.e. sparse).  Give a single value to use</span>
<span class="sd">            globally, or a mapping of {variable: value} or {dtype: value}.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dataset</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Dataset.from_idce : Construct a Dataset from a sparse idca-format DataFrame.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;source idca dataframe must have a two &quot;</span>
                             <span class="s2">&quot;level MultiIndex giving case and alt id&#39;s&quot;</span><span class="p">)</span>
        <span class="n">caseidname</span><span class="p">,</span> <span class="n">altidname</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>

        <span class="c1"># check altids are integers, if they are not then fix it</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">altnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">altnames</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">altnames</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">(</span><span class="n">altnames</span><span class="p">))</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">new_index</span><span class="o">.</span><span class="n">codes</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">altnames</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">caseid</span><span class="o">=</span><span class="n">caseidname</span><span class="p">,</span> <span class="n">alts</span><span class="o">=</span><span class="n">altidname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crack</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">dissolve_zero_variance</span><span class="p">()</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">altnames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_altnames</span><span class="p">(</span><span class="n">altnames</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">avail</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ds</span><span class="o">.</span><span class="n">n_cases</span> <span class="o">*</span> <span class="n">ds</span><span class="o">.</span><span class="n">n_alts</span><span class="p">:</span>
            <span class="n">av</span> <span class="o">=</span> <span class="n">DataArray</span><span class="o">.</span><span class="n">from_series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">avail</span><span class="p">]</span> <span class="o">=</span> <span class="n">av</span>
            <span class="k">if</span> <span class="n">fill_missing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill_missing</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">ALTID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fill_missing</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fill_missing</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">filler</span> <span class="o">=</span> <span class="n">fill_missing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fill_missing</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">dtype</span><span class="p">])</span>
                        <span class="n">ds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;_avail_&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filler</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">ALTID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">ds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;_avail_&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fill_missing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Dataset.from_idce"><a class="viewcode-back" href="../../api/generated/larch.Dataset.from_idce.html#larch.Dataset.from_idce">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_idce</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">crack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">altnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dim_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_index</span><span class="o">=</span><span class="s1">&#39;alt_idx&#39;</span><span class="p">,</span> <span class="n">case_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">case_pointer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a Dataset from a sparse idca-format DataFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            The input data should be an idca-format or idce-format DataFrame,</span>
<span class="sd">            with the caseid&#39;s and altid&#39;s in a two-level pandas MultiIndex.</span>
<span class="sd">        crack : bool, default False</span>
<span class="sd">            If True, the `dissolve_zero_variance` method is applied before</span>
<span class="sd">            repairing dtypes, to ensure that missing value are handled</span>
<span class="sd">            properly.</span>
<span class="sd">        altnames : Mapping, optional</span>
<span class="sd">            If given as a mapping, links alternative codes to names.</span>
<span class="sd">            An array or list of strings gives names for the alternatives,</span>
<span class="sd">            sorted in the same order as the codes.</span>
<span class="sd">        dim_name : str, optional</span>
<span class="sd">            Name to apply to the sparse index dimension.</span>
<span class="sd">        alt_index : str, default &#39;alt_idx&#39;</span>
<span class="sd">            Add the alt index (position) for each sparse data row as a</span>
<span class="sd">            coords array with this name.</span>
<span class="sd">        case_index : str, optional</span>
<span class="sd">            Add the case index (position) for each sparse data row as a</span>
<span class="sd">            coords array with this name. If not given, this array is not</span>
<span class="sd">            stored but it can still be reconstructed later from the case</span>
<span class="sd">            pointers.</span>
<span class="sd">        case_pointer : str, optional</span>
<span class="sd">            Use this name for the case_ptr dimension, overriding the</span>
<span class="sd">            default.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dataset</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Dataset.from_idca : Construct a dense Dataset from a idca-format DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;source idce dataframe must have a two &quot;</span>
                             <span class="s2">&quot;level MultiIndex giving case and alt id&#39;s&quot;</span><span class="p">)</span>
        <span class="n">caseidname</span><span class="p">,</span> <span class="n">altidname</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
        <span class="n">caseidname</span> <span class="o">=</span> <span class="n">caseidname</span> <span class="ow">or</span> <span class="n">_CASEID</span>
        <span class="n">altidname</span> <span class="o">=</span> <span class="n">altidname</span> <span class="ow">or</span> <span class="n">_ALTID</span>
        <span class="n">dim_name</span> <span class="o">=</span> <span class="n">dim_name</span> <span class="ow">or</span> <span class="n">_CASEALT</span>
        <span class="n">case_pointer</span> <span class="o">=</span> <span class="n">case_pointer</span> <span class="ow">or</span> <span class="n">_CASEPTR</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">dim_name</span><span class="p">))</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">caseidname</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">caseidname</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">altidname</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">altidname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">case_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">case_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dim_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alt_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;alt_index cannot be None&#39;</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">alt_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dim_name</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">case_pointer</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prepend</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">dims</span><span class="o">=</span><span class="n">case_pointer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;_exclude_dims_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">caseidname</span><span class="p">,</span> <span class="n">altidname</span><span class="p">,</span> <span class="n">case_pointer</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEID</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseidname</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_ALTID</span><span class="p">]</span> <span class="o">=</span> <span class="n">altidname</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEALT</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_name</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_ALTIDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt_index</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_CASEPTR</span><span class="p">]</span> <span class="o">=</span> <span class="n">case_pointer</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crack</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">dissolve_zero_variance</span><span class="p">()</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">altnames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_altnames</span><span class="p">(</span><span class="n">altnames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Dataset.from_idco"><a class="viewcode-back" href="../../api/generated/larch.Dataset.from_idco.html#larch.Dataset.from_idco">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_idco</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">alts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a Dataset from an idco-format DataFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            The input data should be an idco-format DataFrame, with</span>
<span class="sd">            the caseid&#39;s in a single-level index,</span>
<span class="sd">        alts : Mapping or array-like, optional</span>
<span class="sd">            If given as a mapping, links alternative codes to names.</span>
<span class="sd">            An array or list of integers gives codes for the alternatives,</span>
<span class="sd">            which are otherwise unnamed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;source idco dataframe must have a one &quot;</span>
                             <span class="s2">&quot;level Index giving case id&#39;s&quot;</span><span class="p">)</span>
        <span class="n">caseidname</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">caseid</span><span class="o">=</span><span class="n">caseidname</span><span class="p">,</span> <span class="n">alts</span><span class="o">=</span><span class="n">alts</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span></div>

    <span class="k">def</span> <span class="nf">as_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert this Dataset to a DataTree.</span>

<span class="sd">        For |idco| and |idca| datasets, the result will generally be a</span>
<span class="sd">        single-node tree.  For |idce| data, there will be</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        label : str, default &#39;main&#39;</span>
<span class="sd">            Name to use for the root node in the tree.</span>
<span class="sd">        exclude_dims : Tuple[str], optional</span>
<span class="sd">            Exclude these dimensions, in addition to any</span>
<span class="sd">            dimensions listed in the `_exclude_dims_` attribute.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataTree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CASEPTR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case_index</span> <span class="o">=</span> <span class="n">case_ptr_to_indexes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEALT</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEPTR</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign</span><span class="p">({</span><span class="s1">&#39;_case_index_&#39;</span><span class="p">:</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">case_index</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEALT</span><span class="p">))})</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">DataTree</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="p">)})</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">keep_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_exclude_dims_&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_caseptr_&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_casealt_&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_alt_idx_&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span>
                <span class="s1">&#39;idcoVars&#39;</span><span class="p">,</span>
                <span class="n">ds</span><span class="p">,</span>
                <span class="n">relationships</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">._case_index_ -&gt; idcoVars.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">DataTree</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">tree</span>

<div class="viewcode-block" id="Dataset.setup_flow"><a class="viewcode-back" href="../../api/generated/larch.Dataset.setup_flow.html#larch.Dataset.setup_flow">[docs]</a>    <span class="k">def</span> <span class="nf">setup_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up a new Flow for analysis using the structure of this DataTree.</span>

<span class="sd">        This method creates a new `DataTree` with only this Dataset as</span>
<span class="sd">        the root Dataset labeled `main`.  All other arguments are passed</span>
<span class="sd">        through to `DataTree.setup_flow`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Flow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_tree</span><span class="p">()</span><span class="o">.</span><span class="n">setup_flow</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dataset.caseids"><a class="viewcode-back" href="../../api/generated/larch.Dataset.caseids.html#larch.Dataset.caseids">[docs]</a>    <span class="k">def</span> <span class="nf">caseids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access the caseids coordinates as an index.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.Index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">altids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access the altids coordinates as an index.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.Index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span><span class="p">]</span></div>


<div class="viewcode-block" id="DataTree"><a class="viewcode-back" href="../../api/generated/larch.DataTree.html#larch.DataTree">[docs]</a><span class="k">class</span> <span class="nc">DataTree</span><span class="p">(</span><span class="n">_sharrow_DataTree</span><span class="p">):</span>

    <span class="n">DatasetType</span> <span class="o">=</span> <span class="n">Dataset</span>

<div class="viewcode-block" id="DataTree.__init__"><a class="viewcode-back" href="../../api/generated/larch.DataTree.html#larch.DataTree.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">root_node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_funcs</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">extra_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">relationships</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">force_digitization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span>
            <span class="n">root_node_name</span><span class="o">=</span><span class="n">root_node_name</span><span class="p">,</span>
            <span class="n">extra_funcs</span><span class="o">=</span><span class="n">extra_funcs</span><span class="p">,</span>
            <span class="n">extra_vars</span><span class="o">=</span><span class="n">extra_vars</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">relationships</span><span class="o">=</span><span class="n">relationships</span><span class="p">,</span>
            <span class="n">force_digitization</span><span class="o">=</span><span class="n">force_digitization</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dim_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dim_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_ALTID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dim_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dim_order</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">idco_subtree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;idcoVars&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="s1">&#39;idcoVars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_tree</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span><span class="p">,</span> <span class="n">ignore_missing_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">CASEID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str : The _caseid_ dimension of the root Dataset.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;no defined CASEID&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_CASEID</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ALTID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str : The _altid_ dimension of the root Dataset.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_ALTID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;no defined ALTID&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_ALTID</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">CASEALT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str : The _casealt_ dimension of the root Dataset, if defined.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEALT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ALTIDX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str : The _alt_idx_ dimension of the root Dataset, if defined.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_ALTIDX</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">CASEPTR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str : The _caseptr_ dimension of the root Dataset, if defined.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_CASEPTR</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;int : The size of the _caseid_ dimension of the root Dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_alts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;int : The size of the _altid_ dimension of the root Dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span><span class="p">]</span>

<div class="viewcode-block" id="DataTree.query_cases"><a class="viewcode-back" href="../../api/generated/larch.DataTree.query_cases.html#larch.DataTree.query_cases">[docs]</a>    <span class="k">def</span> <span class="nf">query_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new DataTree, with a query filter applied to the root Dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query : str</span>
<span class="sd">            Python expressions to be evaluated against the data variables</span>
<span class="sd">            in the root dataset. The expressions will be evaluated using the pandas</span>
<span class="sd">            eval() function, and can contain any valid Python expressions but cannot</span>
<span class="sd">            contain any Python statements.</span>
<span class="sd">        parser : {&quot;pandas&quot;, &quot;python&quot;}, default: &quot;pandas&quot;</span>
<span class="sd">            The parser to use to construct the syntax tree from the expression.</span>
<span class="sd">            The default of &#39;pandas&#39; parses code slightly different than standard</span>
<span class="sd">            Python. Alternatively, you can parse an expression using the &#39;python&#39;</span>
<span class="sd">            parser to retain strict Python semantics.</span>
<span class="sd">        engine : {&quot;python&quot;, &quot;numexpr&quot;, None}, default: None</span>
<span class="sd">            The engine used to evaluate the expression. Supported engines are:</span>

<span class="sd">            - None: tries to use numexpr, falls back to python</span>
<span class="sd">            - &quot;numexpr&quot;: evaluates expressions using numexpr</span>
<span class="sd">            - &quot;python&quot;: performs operations as if you had evald in top level python</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataTree</span>
<span class="sd">            A new DataTree with the same contents as this DataTree, except each</span>
<span class="sd">            array of the root Dataset is indexed by the results of the query on</span>
<span class="sd">            the CASEID dimension.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Dataset.query_cases</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">root_dataset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">query_cases</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="k">def</span> <span class="nf">caseids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access the caseids coordinates as an index.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.Index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CASEID</span><span class="p">]</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">altids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access the altids coordinates as an index.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.Index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ALTID</span><span class="p">]</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="DataTree.setup_flow"><a class="viewcode-back" href="../../api/generated/larch.DataTree.setup_flow.html#larch.DataTree.setup_flow">[docs]</a>    <span class="k">def</span> <span class="nf">setup_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up a new Flow for analysis using the structure of this DataTree.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        definition_spec : Dict[str,str]</span>
<span class="sd">            Gives the names and expressions that define the variables to</span>
<span class="sd">            create in this new `Flow`.</span>
<span class="sd">        cache_dir : Path-like, optional</span>
<span class="sd">            A location to write out generated python and numba code. If not</span>
<span class="sd">            provided, a unique temporary directory is created.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of this Flow used for writing out cached files. If not</span>
<span class="sd">            provided, a unique name is generated. If `cache_dir` is given,</span>
<span class="sd">            be sure to avoid name conflicts with other flow&#39;s in the same</span>
<span class="sd">            directory.</span>
<span class="sd">        dtype : str, default &quot;float32&quot;</span>
<span class="sd">            The name of the numpy dtype that will be used for the output.</span>
<span class="sd">        boundscheck : bool, default False</span>
<span class="sd">            If True, boundscheck enables bounds checking for array indices, and</span>
<span class="sd">            out of bounds accesses will raise IndexError. The default is to not</span>
<span class="sd">            do bounds checking, which is faster but can produce garbage results</span>
<span class="sd">            or segfaults if there are problems, so try turning this on for</span>
<span class="sd">            debugging if you are getting unexplained errors or crashes.</span>
<span class="sd">        error_model : {&#39;numpy&#39;, &#39;python&#39;}, default &#39;numpy&#39;</span>
<span class="sd">            The error_model option controls the divide-by-zero behavior. Setting</span>
<span class="sd">            it to python causes divide-by-zero to raise exception like</span>
<span class="sd">            CPython. Setting it to numpy causes divide-by-zero to set the</span>
<span class="sd">            result to +/-inf or nan.</span>
<span class="sd">        nopython : bool, default True</span>
<span class="sd">            Compile using numba&#39;s `nopython` mode.  Provided for debugging only,</span>
<span class="sd">            as there&#39;s little point in turning this off for production code, as</span>
<span class="sd">            all the speed benefits of sharrow will be lost.</span>
<span class="sd">        fastmath : bool, default True</span>
<span class="sd">            If true, fastmath enables the use of &quot;fast&quot; floating point transforms,</span>
<span class="sd">            which can improve performance but can result in tiny distortions in</span>
<span class="sd">            results.  See numba docs for details.</span>
<span class="sd">        parallel : bool, default True</span>
<span class="sd">            Enable or disable parallel computation for certain functions.</span>
<span class="sd">        readme : str, optional</span>
<span class="sd">            A string to inject as a comment at the top of the flow Python file.</span>
<span class="sd">        flow_library : Mapping[str,Flow], optional</span>
<span class="sd">            An in-memory cache of precompiled Flow objects.  Using this can result</span>
<span class="sd">            in performance improvements when repeatedly using the same definitions.</span>
<span class="sd">        extra_hash_data : Tuple[Hashable], optional</span>
<span class="sd">            Additional data used for generating the flow hash.  Useful to prevent</span>
<span class="sd">            conflicts when using a flow_library with multiple similar flows.</span>
<span class="sd">        write_hash_audit : bool, default True</span>
<span class="sd">            Writes a hash audit log into a comment in the flow Python file, for</span>
<span class="sd">            debugging purposes.</span>
<span class="sd">        hashing_level : int, default 1</span>
<span class="sd">            Level of detail to write into flow hashes.  Increase detail to avoid</span>
<span class="sd">            hash conflicts for similar flows.  Level 2 adds information about</span>
<span class="sd">            names used in expressions and digital encodings to the flow hash,</span>
<span class="sd">            which prevents conflicts but requires more pre-computation to generate</span>
<span class="sd">            the hash.</span>
<span class="sd">        dim_exclude : Collection[str], optional</span>
<span class="sd">            Exclude these root dataset dimensions from this flow.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Flow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;dim_exclude&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;_exclude_dims_&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dim_exclude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;_exclude_dims_&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_flow</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">merge</span><span class="p">(</span>
        <span class="n">objects</span><span class="p">,</span>
        <span class="n">compat</span><span class="o">=</span> <span class="s2">&quot;no_conflicts&quot;</span><span class="p">,</span>
        <span class="n">join</span><span class="o">=</span> <span class="s2">&quot;outer&quot;</span><span class="p">,</span>
        <span class="n">fill_value</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
        <span class="n">combine_attrs</span> <span class="o">=</span> <span class="s2">&quot;override&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">caseid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">alts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge any number of xarray objects into a single larch.Dataset as variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objects : iterable of Dataset or iterable of DataArray or iterable of dict-like</span>
<span class="sd">        Merge together all variables from these objects. If any of them are</span>
<span class="sd">        DataArray objects, they must have a name.</span>

<span class="sd">    compat : {&quot;identical&quot;, &quot;equals&quot;, &quot;broadcast_equals&quot;, &quot;no_conflicts&quot;, &quot;override&quot;}, optional</span>
<span class="sd">        String indicating how to compare variables of the same name for</span>
<span class="sd">        potential conflicts:</span>
<span class="sd">        - &quot;broadcast_equals&quot;: all values must be equal when variables are</span>
<span class="sd">          broadcast against each other to ensure common dimensions.</span>
<span class="sd">        - &quot;equals&quot;: all values and dimensions must be the same.</span>
<span class="sd">        - &quot;identical&quot;: all values, dimensions and attributes must be the</span>
<span class="sd">          same.</span>
<span class="sd">        - &quot;no_conflicts&quot;: only values which are not null in both datasets</span>
<span class="sd">          must be equal. The returned dataset then contains the combination</span>
<span class="sd">          of all non-null values.</span>
<span class="sd">        - &quot;override&quot;: skip comparing and pick variable from first dataset</span>

<span class="sd">    join : {&quot;outer&quot;, &quot;inner&quot;, &quot;left&quot;, &quot;right&quot;, &quot;exact&quot;}, optional</span>
<span class="sd">        String indicating how to combine differing indexes in objects.</span>
<span class="sd">        - &quot;outer&quot;: use the union of object indexes</span>
<span class="sd">        - &quot;inner&quot;: use the intersection of object indexes</span>
<span class="sd">        - &quot;left&quot;: use indexes from the first object with each dimension</span>
<span class="sd">        - &quot;right&quot;: use indexes from the last object with each dimension</span>
<span class="sd">        - &quot;exact&quot;: instead of aligning, raise `ValueError` when indexes to be</span>
<span class="sd">          aligned are not equal</span>
<span class="sd">        - &quot;override&quot;: if indexes are of same size, rewrite indexes to be</span>
<span class="sd">          those of the first object with that dimension. Indexes for the same</span>
<span class="sd">          dimension must have the same size in all objects.</span>

<span class="sd">    fill_value : scalar or dict-like, optional</span>
<span class="sd">        Value to use for newly missing values. If a dict-like, maps</span>
<span class="sd">        variable names to fill values. Use a data array&#39;s name to</span>
<span class="sd">        refer to its values.</span>

<span class="sd">    combine_attrs : {&quot;drop&quot;, &quot;identical&quot;, &quot;no_conflicts&quot;, &quot;drop_conflicts&quot;, \</span>
<span class="sd">                    &quot;override&quot;} or callable, default: &quot;override&quot;</span>
<span class="sd">        A callable or a string indicating how to combine attrs of the objects being</span>
<span class="sd">        merged:</span>
<span class="sd">        - &quot;drop&quot;: empty attrs on returned Dataset.</span>
<span class="sd">        - &quot;identical&quot;: all attrs must be the same on every object.</span>
<span class="sd">        - &quot;no_conflicts&quot;: attrs from all objects are combined, any that have</span>
<span class="sd">          the same name must also have the same value.</span>
<span class="sd">        - &quot;drop_conflicts&quot;: attrs from all objects are combined, any that have</span>
<span class="sd">          the same name but different values are dropped.</span>
<span class="sd">        - &quot;override&quot;: skip comparing and copy attrs from the first dataset to</span>
<span class="sd">          the result.</span>
<span class="sd">        If a callable, it must expect a sequence of ``attrs`` dicts and a context object</span>
<span class="sd">        as its only parameters.</span>

<span class="sd">    caseid : str, optional, keyword only</span>
<span class="sd">        This named dimension will be marked as the &#39;_caseid_&#39; dimension.</span>

<span class="sd">    alts : str or Mapping or array-like, keyword only</span>
<span class="sd">        If given as a str, this named dimension will be marked as the</span>
<span class="sd">        &#39;_altid_&#39; dimension.  Otherwise, give a Mapping that defines</span>
<span class="sd">        alternative names and (integer) codes or an array of codes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dataset</span>
<span class="sd">        Dataset with combined variables from each object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span>
        <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">objects</span><span class="p">,</span>
            <span class="n">compat</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">,</span>
            <span class="n">join</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">dtypes</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
            <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;override&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">caseid</span><span class="o">=</span><span class="n">caseid</span><span class="p">,</span>
        <span class="n">alts</span><span class="o">=</span><span class="n">alts</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">choice_avail_summary</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">availability_co_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a summary of choice and availability statistics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset : Dataset</span>
<span class="sd">        The loaded dataset to summarize, which should have</span>
<span class="sd">        `ch` and `av` variables.</span>
<span class="sd">    graph : NestingTree, optional</span>
<span class="sd">        The nesting graph.</span>
<span class="sd">    availability_co_vars : dict, optional</span>
<span class="sd">        Also attach the definition of the availability conditions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;ch&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">ch_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ch_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">av_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;av&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.numba.cascading</span> <span class="kn">import</span> <span class="n">array_av_cascade</span><span class="p">,</span> <span class="n">array_ch_cascade</span>

        <span class="n">ch_</span> <span class="o">=</span> <span class="n">array_ch_cascade</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ch&#39;</span><span class="p">),</span> <span class="n">graph</span><span class="p">)</span>
        <span class="n">av_</span> <span class="o">=</span> <span class="n">array_av_cascade</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;av&#39;</span><span class="p">),</span> <span class="n">graph</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ch_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">ch_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">av_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">av</span> <span class="o">=</span> <span class="n">av_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">av</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">arr_wt</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">arr_wt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ch_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ch_w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">ch_</span> <span class="o">*</span> <span class="n">arr_wt</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ch_w</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">av_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">av_w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">av_</span> <span class="o">*</span> <span class="n">arr_wt</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">av_w</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">show_wt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="n">ch_w</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ch_w</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="n">av_w</span> <span class="o">=</span> <span class="n">av</span>
        <span class="n">show_wt</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">av_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ch_</span><span class="p">[</span><span class="n">av_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ch_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ch_</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ch_but_not_av</span> <span class="o">=</span> <span class="n">ch_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arr_wt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ch_but_not_av_w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">ch_</span> <span class="o">*</span> <span class="n">arr_wt</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">ch_</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ch_but_not_av_w</span> <span class="o">=</span> <span class="n">ch_but_not_av</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ch_but_not_av</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ch_but_not_av_w</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
    <span class="n">od</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">standard_sort</span>
        <span class="n">od</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">standard_sort_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">altids</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alt_names&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">od</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alt_names&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_wt</span><span class="p">:</span>
        <span class="n">od</span><span class="p">[</span><span class="s1">&#39;chosen weighted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ch_w</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">od</span><span class="p">[</span><span class="s1">&#39;chosen unweighted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">od</span><span class="p">[</span><span class="s1">&#39;available weighted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">av_w</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">od</span><span class="p">[</span><span class="s1">&#39;available unweighted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">od</span><span class="p">[</span><span class="s1">&#39;chosen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">od</span><span class="p">[</span><span class="s1">&#39;available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ch_but_not_av</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">show_wt</span><span class="p">:</span>
            <span class="n">od</span><span class="p">[</span><span class="s1">&#39;chosen but not available weighted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ch_but_not_av_w</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">od</span><span class="p">[</span><span class="s1">&#39;chosen but not available unweighted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ch_but_not_av</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">od</span><span class="p">[</span><span class="s1">&#39;chosen but not available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ch_but_not_av</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">availability_co_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">od</span><span class="p">[</span><span class="s1">&#39;availability condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">availability_co_vars</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">index</span><span class="o">=</span><span class="n">availability_co_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">od</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">graph</span><span class="o">.</span><span class="n">root_id</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">graph</span><span class="o">.</span><span class="n">root_id</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">tot</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s1">&#39;chosen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;chosen weighted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;chosen unweighted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;chosen but not available&#39;</span><span class="p">,</span>
            <span class="s1">&#39;chosen but not available weighted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;chosen but not available unweighted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;chosen thus available&#39;</span><span class="p">,</span>
            <span class="s1">&#39;not available so not chosen&#39;</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">tot</span> <span class="ow">in</span> <span class="n">totals</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;&lt; Total All Alternatives &gt;&#39;</span><span class="p">,</span> <span class="n">tot</span><span class="p">]</span> <span class="o">=</span> <span class="n">totals</span><span class="p">[</span><span class="n">tot</span><span class="p">]</span>

    <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;&lt; Total All Alternatives &gt;&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;&lt; Total All Alternatives &gt;&#39;</span><span class="p">,</span> <span class="p">:])]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">result</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_root_&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;availability condition&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;availability condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;availability condition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s1">&#39;chosen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;chosen but not available&#39;</span><span class="p">,</span>
            <span class="s1">&#39;chosen thus available&#39;</span><span class="p">,</span>
            <span class="s1">&#39;not available so not chosen&#39;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s1">&#39;available&#39;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>



<span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">ce_dissolve_zero_variance</span><span class="p">(</span><span class="n">ce_data</span><span class="p">,</span> <span class="n">ce_caseptr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ce_data : array-like, shape [n_casealts] one-dim only</span>
<span class="sd">    ce_altidx</span>
<span class="sd">    ce_caseptr</span>
<span class="sd">    n_alts</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : ndarray</span>
<span class="sd">    flag : int</span>
<span class="sd">        1 if variance was detected, 0 if no variance was found and</span>
<span class="sd">        the `out` array is valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ce_caseptr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ce_caseptr1</span> <span class="o">=</span> <span class="n">ce_caseptr</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ce_caseptr1</span> <span class="o">=</span> <span class="n">ce_caseptr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">ce_caseptr1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ce_data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ce_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ce_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">ce_caseptr1</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">out</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">ce_data</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ce_data</span><span class="p">[</span><span class="n">row</span><span class="p">]:</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">failed</span>


<span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">case_ptr_to_indexes</span><span class="p">(</span><span class="n">n_casealts</span><span class="p">,</span> <span class="n">case_ptrs</span><span class="p">):</span>
    <span class="n">case_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_casealts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">case_ptrs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">case_index</span><span class="p">[</span><span class="n">case_ptrs</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span><span class="n">case_ptrs</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">case_index</span>
</pre></div>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Jeffrey Newman<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>