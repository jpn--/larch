
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sharrow.relationships &#8212; 5.5.11.dev57+g96db8ef</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/larch-book.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <link rel="shortcut icon" href="../../_static/larch_favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    
      
      <link rel="icon" sizes="32x32" href="../../_static/img/larch_favicon.png">
      
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/larch-logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">5.5.11.dev57+g96db8ef</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search these docs..." aria-label="Search these docs..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Users Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../installation.html">
   Installing Larch
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../user-guide/choice-models.html">
   Choice Models
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../user-guide/data-fundamentals.html">
     Data Fundamentals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../user-guide/linear-funcs.html">
     Linear Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../user-guide/machine-learning.html">
     Machine Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../bibliography.html">
   References
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  API Reference
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../api/~data.html">
   Data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/dataset.html">
     Dataset
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.html">
       larch.Dataset
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_idca.html">
       larch.Dataset.from_idca
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_idce.html">
       larch.Dataset.from_idce
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_idco.html">
       larch.Dataset.from_idco
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.construct.html">
       larch.Dataset.construct
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_table.html">
       larch.Dataset.from_table
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_omx.html">
       larch.Dataset.from_omx
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_omx_3d.html">
       larch.Dataset.from_omx_3d
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_zarr.html">
       larch.Dataset.from_zarr
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.from_named_objects.html">
       larch.Dataset.from_named_objects
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.n_cases.html">
       larch.Dataset.n_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.n_alts.html">
       larch.Dataset.n_alts
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.CASEID.html">
       larch.Dataset.CASEID
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.ALTID.html">
       larch.Dataset.ALTID
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.alts_mapping.html">
       larch.Dataset.alts_mapping
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.dims.html">
       larch.Dataset.dims
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.sizes.html">
       larch.Dataset.sizes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.data_vars.html">
       larch.Dataset.data_vars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.coords.html">
       larch.Dataset.coords
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.attrs.html">
       larch.Dataset.attrs
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.encoding.html">
       larch.Dataset.encoding
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.indexes.html">
       larch.Dataset.indexes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.chunks.html">
       larch.Dataset.chunks
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.chunksizes.html">
       larch.Dataset.chunksizes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.nbytes.html">
       larch.Dataset.nbytes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.caseids.html">
       larch.Dataset.caseids
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.dissolve_zero_variance.html">
       larch.Dataset.dissolve_zero_variance
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.query_cases.html">
       larch.Dataset.query_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.set_altnames.html">
       larch.Dataset.set_altnames
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.set_dtypes.html">
       larch.Dataset.set_dtypes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.setup_flow.html">
       larch.Dataset.setup_flow
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.Dataset.get_expr.html">
       larch.Dataset.get_expr
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/datatree.html">
     DataTree
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.html">
       larch.DataTree
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.root_node_name.html">
       larch.DataTree.root_node_name
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.subspaces.html">
       larch.DataTree.subspaces
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.relationships_are_digitized.html">
       larch.DataTree.relationships_are_digitized
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.n_cases.html">
       larch.DataTree.n_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.n_alts.html">
       larch.DataTree.n_alts
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.CASEID.html">
       larch.DataTree.CASEID
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.ALTID.html">
       larch.DataTree.ALTID
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.add_dataset.html">
       larch.DataTree.add_dataset
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.add_relationship.html">
       larch.DataTree.add_relationship
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.digitize_relationships.html">
       larch.DataTree.digitize_relationships
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.query_cases.html">
       larch.DataTree.query_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.replace_datasets.html">
       larch.DataTree.replace_datasets
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataTree.setup_flow.html">
       larch.DataTree.setup_flow
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/dataframes.html">
     DataFrames
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.DataFrames.html">
       larch.DataFrames
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../api/~models.html">
   Models
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/model.html">
     Model
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.html">
       larch.numba.Model
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.datatree.html">
       larch.numba.Model.datatree
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.dataset.html">
       larch.numba.Model.dataset
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.n_cases.html">
       larch.numba.Model.n_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.choice_ca_var.html">
       larch.numba.Model.choice_ca_var
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.choice_co_vars.html">
       larch.numba.Model.choice_co_vars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.choice_co_code.html">
       larch.numba.Model.choice_co_code
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.availability_ca_var.html">
       larch.numba.Model.availability_ca_var
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.availability_co_vars.html">
       larch.numba.Model.availability_co_vars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.utility_ca.html">
       larch.numba.Model.utility_ca
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.utility_co.html">
       larch.numba.Model.utility_co
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.quantity_ca.html">
       larch.numba.Model.quantity_ca
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.pf.html">
       larch.numba.Model.pf
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.most_recent_estimation_result.html">
       larch.numba.Model.most_recent_estimation_result
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.possible_overspecification.html">
       larch.numba.Model.possible_overspecification
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.set_values.html">
       larch.numba.Model.set_values
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.lock_value.html">
       larch.numba.Model.lock_value
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.set_cap.html">
       larch.numba.Model.set_cap
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.remove_unused_parameters.html">
       larch.numba.Model.remove_unused_parameters
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.maximize_loglike.html">
       larch.numba.Model.maximize_loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.calculate_parameter_covariance.html">
       larch.numba.Model.calculate_parameter_covariance
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.loglike_nil.html">
       larch.numba.Model.loglike_nil
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.loglike_null.html">
       larch.numba.Model.loglike_null
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.rho_sq_nil.html">
       larch.numba.Model.rho_sq_nil
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.rho_sq_null.html">
       larch.numba.Model.rho_sq_null
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.parameter_summary.html">
       larch.numba.Model.parameter_summary
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.estimation_statistics.html">
       larch.numba.Model.estimation_statistics
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.to_xlsx.html">
       larch.numba.Model.to_xlsx
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.bhhh.html">
       larch.numba.Model.bhhh
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.check_d_loglike.html">
       larch.numba.Model.check_d_loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.d_loglike.html">
       larch.numba.Model.d_loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.d_loglike_casewise.html">
       larch.numba.Model.d_loglike_casewise
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.loglike.html">
       larch.numba.Model.loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.loglike_casewise.html">
       larch.numba.Model.loglike_casewise
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.logsums.html">
       larch.numba.Model.logsums
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.probability.html">
       larch.numba.Model.probability
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.quantity.html">
       larch.numba.Model.quantity
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.total_weight.html">
       larch.numba.Model.total_weight
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.numba.Model.utility.html">
       larch.numba.Model.utility
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/linear.html">
     Linear Functions
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/nesting.html">
     NestingTree
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
    <label for="toctree-checkbox-8">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.html">
       larch.model.tree.NestingTree
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.new_node.html">
       larch.model.tree.NestingTree.new_node
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.add_node.html">
       larch.model.tree.NestingTree.add_node
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.remove_node.html">
       larch.model.tree.NestingTree.remove_node
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.add_edge.html">
       larch.model.tree.NestingTree.add_edge
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.tree.NestingTree.remove_edge.html">
       larch.model.tree.NestingTree.remove_edge
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../api/modelgroup.html">
     ModelGroup
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.html">
       larch.model.model_group.ModelGroup
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.n_cases.html">
       larch.model.model_group.ModelGroup.n_cases
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.set_values.html">
       larch.model.model_group.ModelGroup.set_values
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.total_weight.html">
       larch.model.model_group.ModelGroup.total_weight
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.loglike.html">
       larch.model.model_group.ModelGroup.loglike
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.loglike2.html">
       larch.model.model_group.ModelGroup.loglike2
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../api/generated/larch.model.model_group.ModelGroup.to_xlsx.html">
       larch.model.model_group.ModelGroup.to_xlsx
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Examples
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/mtc.html">
   MTC Mode Choice
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/000_mtc_data.html">
     MTC Work Mode Choice Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/001_mnl.html">
     1: MTC MNL Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/002_mtc.html">
     2: MTC MNL Mode Choice, Motorized
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/017A_mnl_segmented.html">
     17a: Market Segmentatation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/017_mnl_final.html">
     17: MTC Expanded MNL Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/022-nl.html">
     22: MTC Motorized and Non-Motorized Nested Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/028-nl.html">
     28: MTC Motorized - Shared Ride - Non-Motorized Nested Mode Choice
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/swissmetro.html">
   Swissmetro
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/101_swissmetro_mnl.html">
     101: Swissmetro MNL Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/102-swissmetro-weighted.html">
     102: Swissmetro Weighted MNL Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/109-swissmetro-nl.html">
     109: Swissmetro Nested Logit Mode Choice
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/exampville.html">
   Exampville
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/200_exampville.html">
     200: Exampville Simulated Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/201_exville_mode_choice.html">
     201: Exampville Mode Choice
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/202_exville_mc_logsums.html">
     202: Exampville Mode Choice Logsums
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/203_exville_dest.html">
     203: Exampville Destination Choice
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/itinerary.html">
   Itinerary Choice
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/300_itinerary.html">
     300: Itinerary Choice Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../example/301_itin_mnl.html">
     301: Itinerary Choice using MNL
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../example/legacy.html">
   Legacy Examples
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../example/legacy/mtc.html">
     MTC Mode Choice Examples
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
    <label for="toctree-checkbox-15">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/000_mtc_data.html">
       MTC Work Mode Choice Data
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/001.mtc.html">
       1: MTC MNL Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/002_mtc.html">
       2: MTC MNL Mode Choice, Motorized
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/003_mtc.html">
       3: MTC MNL Mode Choice, Zeroed Shared
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/005_mtc.html">
       5: MTC MNL Mode Choice, Motorized Travel Time
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/006_mtc.html">
       6: MTC MNL Mode Choice, Motorized Times
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/007_mtc.html">
       7: MTC MNL Mode Choice, Diminishing OVTT by Distance
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/008_mtc.html">
       8: MTC MNL Mode Choice, TTR = 2.5
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/009_mtc.html">
       9: MTC MNL Mode Choice, TTR = 4.0
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/010_mtc.html">
       10: MTC MNL Mode Choice, Autos per Household
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/011_mtc.html">
       11: MTC MNL Mode Choice, Vehicle by Worker
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/012_mtc.html">
       12: MTC MNL Mode Choice, Autos per Adult
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/013_mtc.html">
       13: MTC MNL Mode Choice, CBD
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/014_mtc.html">
       14: MTC MNL Mode Choice, Work Zone Density
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/015_mtc.html">
       15: MTC MNL Mode Choice, CBD and Work Zone Density
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/016_mtc.html">
       16: MTC MNL Mode Choice, Cost by Income
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017A_mtc.html">
       17A: MTC MNL Mode Choice, Segmented for 1 or fewer cars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017B_mtc.html">
       17B: MTC MNL Mode Choice, Segmented for 2 or more cars
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017C_mtc.html">
       17C: MTC MNL Mode Choice, Segmented for Males
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017D_mtc.html">
       17D: MTC MNL Mode Choice, Segmented for Females
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/017_mtc.html">
       17: MTC Expanded MNL Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/018_mtc.html">
       18: MTC Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/019_mtc.html">
       19: MTC Private Auto Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/020_mtc.html">
       20: MTC Shared Ride Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/021_mtc.html">
       21: MTC Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/022_mtc.html">
       22: MTC Motorized and Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/023_mtc.html">
       23W: MTC Private Auto - Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/024_mtc.html">
       23W: MTC Shared Ride - Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/025_mtc.html">
       25: MTC Private Auto - Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/026_mtc.html">
       26: MTC Shared Ride - Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/027_mtc.html">
       27: MTC Shared Ride - Private Auto Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/028_mtc.html">
       28: MTC Motorized - Shared Ride - Non-Motorized Nested Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/029_mtc.html">
       29: MTC Motorized - Shared Ride - Private Auto Nested Mode Choice
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../example/legacy/swissmetro.html">
     Swissmetro Examples
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
    <label for="toctree-checkbox-16">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/101_mnl.html">
       101: Swissmetro MNL Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/102_mnl_weighted.html">
       102: Swissmetro Weighted MNL Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/107_latent_class.html">
       107: Latent Class Models
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/109_nl.html">
       109: Swissmetro Nested Logit Mode Choice
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/111_cnl.html">
       111: Swissmetro Cross-Nested Logit Mode Choice
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../example/legacy/itinerary.html">
     Itinerary Choice Examples
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
    <label for="toctree-checkbox-17">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/300L_itinerary.html">
       300L: Itinerary Choice Data
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/301_itin_mnl.html">
       301: Itinerary Choice using MNL
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../example/legacy/302_itin_nl.html">
       302: Itinerary Choice using Simple Nested Logit
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/jpn--/larch"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/jpn--/larch/issues/new?title=Issue%20on%20page%20%2F_modules/sharrow/relationships.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            
              <div>
                
  <h1>Source code for sharrow.relationships</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">from</span> <span class="nn">.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;sharrow&quot;</span><span class="p">)</span>

<span class="n">well_known_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;nb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;np&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;xr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pa&quot;</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;log1p&quot;</span><span class="p">,</span>
    <span class="s2">&quot;expm1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;max&quot;</span><span class="p">,</span>
    <span class="s2">&quot;min&quot;</span><span class="p">,</span>
    <span class="s2">&quot;piece&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hard_sigmoid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;transpose_leading&quot;</span><span class="p">,</span>
    <span class="s2">&quot;clip&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_require_string</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;must be string&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">_iat</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_index_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">idxs</span><span class="p">):</span>
    <span class="n">loaders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">_index_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_index_name</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">idxs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">loaders</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">_index_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loaders</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_index_name</span><span class="si">}{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">ndim</span><span class="p">)]</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">_names</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">_names</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">source</span>
    <span class="k">if</span> <span class="n">_load</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="o">**</span><span class="n">loaders</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_at</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_index_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">idxs</span><span class="p">):</span>
    <span class="n">loaders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">_index_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_index_name</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">idxs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">loaders</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">_index_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loaders</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_index_name</span><span class="si">}{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">ndim</span><span class="p">)]</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">_names</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">_names</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">source</span>
    <span class="k">if</span> <span class="n">_load</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">loaders</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gather</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">indexes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract values by label on the coordinates indicated by columns of a DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : xarray.DataArray or xarray.Dataset</span>
<span class="sd">        The source of the values to extract.</span>
<span class="sd">    indexes : Mapping[str, array-like]</span>
<span class="sd">        The keys of `indexes` (if given as a dataframe, the column names)</span>
<span class="sd">        should match the named dimensions of `source`.  The resulting extracted</span>
<span class="sd">        data will have a shape one row per row of `df`, and columns matching</span>
<span class="sd">        the data variables in `source`, and each value is looked up by the labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">_at</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">indexes</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">igather</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract values by position on the coordinates indicated by columns of a DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : xarray.DataArray or xarray.Dataset</span>
<span class="sd">    positions : pd.DataFrame or Mapping[str, array-like]</span>
<span class="sd">        The columns (or keys) of `df` should match the named dimensions of</span>
<span class="sd">        this Dataset.  The resulting extracted DataFrame will have one row</span>
<span class="sd">        per row of `df`, columns matching the data variables in this dataset,</span>
<span class="sd">        and each value is looked up by the positions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">_iat</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">positions</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">xgather</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">indexes</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">igather</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gather</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">indexes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gather</span><span class="p">(</span><span class="n">igather</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">positions</span><span class="p">),</span> <span class="n">indexes</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Relationship</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a linkage between datasets in a `DataTree`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parent_data</span><span class="p">,</span>
        <span class="n">parent_name</span><span class="p">,</span>
        <span class="n">child_data</span><span class="p">,</span>
        <span class="n">child_name</span><span class="p">,</span>
        <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
        <span class="n">analog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_data</span> <span class="o">=</span> <span class="n">_require_string</span><span class="p">(</span><span class="n">parent_data</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;str: Name of the parent dataset.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent_name</span> <span class="o">=</span> <span class="n">_require_string</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;str: Variable in the parent dataset that references the child dimension.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">child_data</span> <span class="o">=</span> <span class="n">_require_string</span><span class="p">(</span><span class="n">child_data</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;str: Name of the child dataset.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">child_name</span> <span class="o">=</span> <span class="n">_require_string</span><span class="p">(</span><span class="n">child_name</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;str: Dimension in the child dataset that is used by this relationship.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">indexing</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;indexing must be by label or position&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexing</span> <span class="o">=</span> <span class="n">indexing</span>
        <span class="sd">&quot;&quot;&quot;str: How the target dimension is used, either by &#39;label&#39; or &#39;position&#39;.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">analog</span> <span class="o">=</span> <span class="n">analog</span>
        <span class="sd">&quot;&quot;&quot;str: Original variable that defined label-based relationship before digitization.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Relationship by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">indexing</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_data</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_name</span><span class="si">!r}</span><span class="s2">] -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">child_data</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">child_name</span><span class="si">!r}</span><span class="s2">]&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">parent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_name</span><span class="p">,</span>
            <span class="n">child_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">child_name</span><span class="p">,</span>
            <span class="n">indexing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">indexing</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a `Relationship` from a string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s : str</span>
<span class="sd">            The relationship definition.</span>
<span class="sd">            To create a label-based relationship, the string should look like</span>
<span class="sd">            &quot;ParentNode.variable_name @ ChildNode.dimension_name&quot;.  To create</span>
<span class="sd">            a position-based relationship, give</span>
<span class="sd">            &quot;ParentNode.variable_name -&gt; ChildNode.dimension_name&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Relationship</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;-&gt;&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">child</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="s2">&quot;position&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;@&quot;</span><span class="p">:</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">child</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">parent_data</span><span class="o">=</span><span class="n">p1</span><span class="p">,</span>
            <span class="n">parent_name</span><span class="o">=</span><span class="n">p2</span><span class="p">,</span>
            <span class="n">child_data</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span>
            <span class="n">child_name</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span>
            <span class="n">indexing</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">DataTree</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A tree representing linked datasets, from which data can flow.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : networkx.MultiDiGraph</span>
<span class="sd">    root_node_name : str</span>
<span class="sd">        The name of the node at the root of the tree.</span>
<span class="sd">    extra_funcs : Tuple[Callable]</span>
<span class="sd">        Additional functions that can be called by Flow objects created</span>
<span class="sd">        using this DataTree.  These functions should have defined `__name__`</span>
<span class="sd">        attributes, so they can be called in expressions.</span>
<span class="sd">    extra_vars : Mapping[str,Any], optional</span>
<span class="sd">        Additional named constants that can be referenced by expressions in</span>
<span class="sd">        Flow objects created using this DataTree.</span>
<span class="sd">    cache_dir : Path-like, optional</span>
<span class="sd">        The default directory where Flow objects are created.</span>
<span class="sd">    relationships : Iterable[str or Relationship]</span>
<span class="sd">        The relationship definitions used to define this tree.  All dataset</span>
<span class="sd">        nodes named in these relationships should also be included as</span>
<span class="sd">        keyword arguments for this constructor.</span>
<span class="sd">    force_digitization : bool, default False</span>
<span class="sd">        Whether to automatically digitize all relationships (converting them</span>
<span class="sd">        from label-based to position-based).  Digitization is required to</span>
<span class="sd">        evaluate Flows, but doing so automatically on construction may be</span>
<span class="sd">        inefficient.</span>
<span class="sd">    dim_order : Tuple[str], optional</span>
<span class="sd">        The order of dimensions to use in Flow outputs.  Generally only needed</span>
<span class="sd">        if there are multiple dimensions in the root dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DatasetType</span> <span class="o">=</span> <span class="n">Dataset</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">root_node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_funcs</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">extra_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">relationships</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">force_digitization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dim_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;datasets must be given as keyword arguments&quot;</span><span class="p">)</span>

        <span class="c1"># raw init</span>
        <span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_node_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_digitization</span> <span class="o">=</span> <span class="n">force_digitization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span> <span class="o">=</span> <span class="n">dim_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># defined init</span>
        <span class="k">if</span> <span class="n">root_node_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">root_node_name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="n">root_node_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">root_node_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span> <span class="o">=</span> <span class="n">root_node_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_funcs</span> <span class="o">=</span> <span class="n">extra_funcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_vars</span> <span class="o">=</span> <span class="n">extra_vars</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_indexes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">root_node_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="n">root_node_name</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relationships</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_relationship</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force_digitization</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digitize_relationships</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple[int]: base shape of arrays that will be loaded when using this DataTree.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">:</span>
            <span class="n">dim_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.flows</span> <span class="kn">import</span> <span class="n">presorted</span>

            <span class="n">dim_order</span> <span class="o">=</span> <span class="n">presorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dim_order</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__shallow_copy_extras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">extra_funcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_funcs</span><span class="p">,</span>
            <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">force_digitization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force_digitization</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> datasets:&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> datasets: none&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> relationships:&quot;</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_relationship</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;&lt;Relationship &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> relationships: none&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_hash_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dataset:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dataset:</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;datasets:none&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;relationship:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_relationship</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;&lt;Relationship &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;relationships:none&quot;</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dim_order:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_node_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: The root node for this data tree, which is only ever a parent.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_node_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nodename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">nodename</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_root_node_name</span> <span class="o">=</span> <span class="n">nodename</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_node_name</span>

    <span class="nd">@root_node_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">root_node_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_root_node_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;root_node_name must be str not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_node_name</span> <span class="o">=</span> <span class="n">name</span>

<div class="viewcode-block" id="DataTree.add_relationship"><a class="viewcode-back" href="../../api/generated/larch.DataTree.add_relationship.html#larch.DataTree.add_relationship">[docs]</a>    <span class="k">def</span> <span class="nf">add_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a relationship to this DataTree.</span>

<span class="sd">        The new relationship will point from a variable in one dataset</span>
<span class="sd">        to a dimension of another dataset in this tree.  Both the parent</span>
<span class="sd">        and the child datasets should already have been added.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *args, **kwargs</span>
<span class="sd">            All arguments are passed through to the `Relationship`</span>
<span class="sd">            contructor, unless only a single `str` argument is provided,</span>
<span class="sd">            in which case the `Relationship.from_string` class constructor</span>
<span class="sd">            is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Relationship</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;-&gt;&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">child</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="s2">&quot;position&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;@&quot;</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">child</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span>
            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">Relationship</span><span class="p">(</span>
                <span class="n">parent_data</span><span class="o">=</span><span class="n">p1</span><span class="p">,</span>
                <span class="n">parent_name</span><span class="o">=</span><span class="n">p2</span><span class="p">,</span>
                <span class="n">child_data</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span>
                <span class="n">child_name</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span>
                <span class="n">indexing</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">Relationship</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># check for existing relationships, don&#39;t duplicate</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relationship</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">r2</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="c1"># confirm correct pointer</span>
        <span class="n">r</span><span class="o">.</span><span class="n">parent_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finditem</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">parent_name</span><span class="p">,</span> <span class="n">maybe_in</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">parent_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">parent_data</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">child_data</span><span class="p">,</span> <span class="o">**</span><span class="n">r</span><span class="o">.</span><span class="n">attrs</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_digitization</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digitize_relationships</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Relationship</span><span class="p">(</span><span class="n">parent_data</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_data</span><span class="o">=</span><span class="n">child</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>

<div class="viewcode-block" id="DataTree.add_dataset"><a class="viewcode-back" href="../../api/generated/larch.DataTree.add_dataset.html#larch.DataTree.add_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">add_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">relationships</span><span class="o">=</span><span class="p">(),</span> <span class="n">as_root</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new Dataset node to this DataTree.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">        dataset : Dataset or pandas.DataFrame</span>
<span class="sd">            Will be coerced into a `Dataset` object if it is not already</span>
<span class="sd">            in that format, using a no-copy process if possible.</span>
<span class="sd">        relationships : Tuple[str or Relationship]</span>
<span class="sd">            Also add these relationships.</span>
<span class="sd">        as_root : bool, default False</span>
<span class="sd">            Set this new node as the root of the tree, displacing any existing</span>
<span class="sd">            root.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DatasetType</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">as_root</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relationships</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">relationships</span> <span class="o">=</span> <span class="p">[</span><span class="n">relationships</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relationships</span><span class="p">:</span>
            <span class="c1"># TODO validate relationships before adding.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_relationship</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_digitization</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digitize_relationships</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">add_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Sequence</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_items</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">items</span> <span class="ow">and</span> <span class="s2">&quot;dataset&quot;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">])</span>
                <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preload</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">preload</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">}:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;relationships&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_relationship</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;add_items requires Sequence or Mapping&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span>

    <span class="nd">@root_dataset</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">root_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DatasetType</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">_get_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Relationship</span><span class="p">(</span>
            <span class="n">parent_data</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">child_data</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="kn">from</span> <span class="nn">.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>

            <span class="k">return</span> <span class="n">Dataset</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">include_blank_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finditem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">maybe_in</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">maybe_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">maybe_in</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">maybe_in</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">maybe_in</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">just_node_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getitem</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">include_blank_dims</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">only_dims</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">just_node_name</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="kn">from</span> <span class="nn">.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>

            <span class="k">return</span> <span class="n">Dataset</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="p">})</span>

        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">item_in</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item_in</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">queue</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">]</span>
        <span class="n">examined</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">):</span>
            <span class="n">current_node</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_node</span> <span class="ow">in</span> <span class="n">examined</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">current_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">by_name</span> <span class="o">=</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">only_dims</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">by_name</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">by_dims</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">by_name</span> <span class="ow">and</span> <span class="n">include_blank_dims</span> <span class="ow">and</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">by_dims</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">by_name</span> <span class="ow">or</span> <span class="n">by_dims</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">item_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">item_in</span> <span class="o">==</span> <span class="n">current_node</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">just_node_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">current_node</span>
                <span class="k">if</span> <span class="n">current_node</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">by_dims</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                            <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="n">item</span><span class="p">]),</span> <span class="n">dims</span><span class="o">=</span><span class="n">item</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">dataset</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_positions</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">_labels</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">by_dims</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                            <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">item</span><span class="p">]}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">coords</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                            <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="n">item</span><span class="p">]),</span>
                            <span class="n">dims</span><span class="o">=</span><span class="n">item</span><span class="p">,</span>
                            <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                    <span class="n">dims_in_result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">simple_paths</span><span class="o">.</span><span class="n">all_simple_edge_paths</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">,</span> <span class="n">current_node</span>
                    <span class="p">):</span>
                        <span class="n">path_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;child_name&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">path_dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dims_in_result</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="c1"># path_indexing = self._graph.edges[path[-1]].get(&#39;indexing&#39;)</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1"># intermediate nodes on path</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e_next</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relationship</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="n">r_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relationship</span><span class="p">(</span><span class="n">e_next</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_data</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">)</span>
                            <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">child_data</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">)[</span>
                                <span class="p">[</span><span class="n">r_next</span><span class="o">.</span><span class="n">parent_name</span><span class="p">]</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">indexing</span> <span class="o">==</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span>
                                <span class="n">t1</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
                                    <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">child_name</span><span class="p">:</span> <span class="n">t1</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()}</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>  <span class="c1"># by position</span>
                                <span class="n">t1</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span>
                                    <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">child_name</span><span class="p">:</span> <span class="n">t1</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()}</span>
                                <span class="p">)</span>
                        <span class="c1"># final node in path</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">Relationship</span><span class="p">(</span>
                            <span class="n">parent_data</span><span class="o">=</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">child_data</span><span class="o">=</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_data</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">indexing</span> <span class="o">==</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span>
                            <span class="n">_labels</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">child_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># by position</span>
                            <span class="n">_idx</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">_idx</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
                                <span class="n">_idx</span> <span class="o">=</span> <span class="n">_idx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                            <span class="n">_positions</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">child_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_idx</span>

                    <span class="n">y</span> <span class="o">=</span> <span class="n">xgather</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">_positions</span><span class="p">,</span> <span class="n">_labels</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">y</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims_in_result</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">_i</span><span class="p">:</span> <span class="n">_j</span> <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">dims</span><span class="p">)})</span>
                    <span class="k">return</span> <span class="n">y</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">examined</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">next_up</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">current_node</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">next_up</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">examined</span><span class="p">:</span>
                        <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_up</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;sharrow&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access or evaluate an expression.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        expression : str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataArray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">expression</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;sharrow&quot;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setup_flow</span><span class="p">({</span><span class="n">expression</span><span class="p">:</span> <span class="n">expression</span><span class="p">})</span>
                    <span class="o">.</span><span class="n">load_dataarray</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">expressions</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;numexpr&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">xarray</span> <span class="kn">import</span> <span class="n">DataArray</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">resolvers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subspaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mapping[str,Dataset] : Direct access to node Dataset objects by name.&quot;&quot;&quot;</span>
        <span class="n">spaces</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spaces</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">spaces</span>

    <span class="k">def</span> <span class="nf">subspaces_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">namespace_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">spacename</span><span class="p">,</span> <span class="n">spacearrays</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces_iter</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">spacearrays</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">namespace</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">spacename</span> <span class="ow">or</span> <span class="s1">&#39;base&#39;</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">spacearrays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">namespace</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">spacename</span> <span class="ow">or</span> <span class="s1">&#39;base&#39;</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">namespace</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mapping from dimension names to lengths across all dataset nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces_iter</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;inconsistent dimensions</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims_detail</span><span class="p">()</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dims</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Frozen</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dims_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Report on the names and sizes of dimensions in all Dataset nodes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspaces_iter</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">:&quot;</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">drop_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_missing_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drop dimensions from root Dataset node.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dims : str or Iterable[str]</span>
<span class="sd">            One or more named dimensions to drop.</span>
<span class="sd">        inplace : bool, default False</span>
<span class="sd">            Whether to drop dimensions in-place.</span>
<span class="sd">        ignore_missing_dims : bool, default True</span>
<span class="sd">            Simply ignore any dimensions that are not present.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataTree</span>
<span class="sd">            Returns self if dropping inplace, otherwise returns a copy</span>
<span class="sd">            with dimensions dropped.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">dims</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_missing_dims</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">root_dataset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">root_dataset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">dim_order</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">position_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">replacements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">check_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="p">(</span><span class="n">position_only</span><span class="p">,</span> <span class="n">as_dict</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_indexes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_indexes</span><span class="p">[(</span><span class="n">position_only</span><span class="p">,</span> <span class="n">as_dict</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">position_only</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">d</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">replacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_datasets</span><span class="p">(</span><span class="n">replacements</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
            <span class="n">result_k</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">include_blank_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result_shape</span> <span class="o">=</span> <span class="n">result_k</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">result_shape</span> <span class="o">!=</span> <span class="n">result_k</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">check_shapes</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;inconsistent index shapes </span><span class="si">{</span><span class="n">result_k</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> v </span><span class="si">{</span><span class="n">result_shape</span><span class="si">}</span><span class="s2"> (probably an error on </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dims</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_k</span>

        <span class="k">if</span> <span class="n">as_dict</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_indexes</span><span class="p">[(</span><span class="n">position_only</span><span class="p">,</span> <span class="n">as_dict</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="DataTree.replace_datasets"><a class="viewcode-back" href="../../api/generated/larch.DataTree.replace_datasets.html#larch.DataTree.replace_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">replace_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">redigitize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace one or more datasets in the nodes of this tree.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : Mapping[str,Dataset]</span>
<span class="sd">            A dictionary of replacement datasets.</span>
<span class="sd">        validate : bool, default True</span>
<span class="sd">            Raise an error when replacing downstream datasets that</span>
<span class="sd">            are referenced by position, unless the replacement is identically</span>
<span class="sd">            sized.  If validation is deactivated, and an incompatible dataset</span>
<span class="sd">            is placed in this tree, flows that rely on that relationship will</span>
<span class="sd">            give erroneous results or crash with a segfault.</span>
<span class="sd">        redigitize : bool, default True</span>
<span class="sd">            Automatically re-digitize relationships that are label-based and</span>
<span class="sd">            were previously digitized.</span>
<span class="sd">        **kwargs : Mapping[str,Dataset]</span>
<span class="sd">            Alternative format to `other`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataTree</span>
<span class="sd">            A new DataTree with data replacements completed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">replacements</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">replacements</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">replacements</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DatasetType</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">replacements</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dims</span> <span class="o">!=</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="c1"># when replacement dimensions do not match, check for</span>
                    <span class="c1"># any upstream nodes that reference this dataset by</span>
                    <span class="c1"># position... which will potentially be problematic.</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                            <span class="n">indexing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indexing&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">indexing</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;dimensions mismatch on &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;positionally-referenced dataset </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;receiving </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2"> &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;expected </span><span class="si">{</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">__shallow_copy_extras</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">redigitize</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">digitize_relationships</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">setup_flow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">definition_spec</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span>
        <span class="n">boundscheck</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">,</span>
        <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">readme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_library</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_hash_data</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">write_hash_audit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">hashing_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">dim_exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up a new Flow for analysis using the structure of this DataTree.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        definition_spec : Dict[str,str]</span>
<span class="sd">            Gives the names and expressions that define the variables to</span>
<span class="sd">            create in this new `Flow`.</span>
<span class="sd">        cache_dir : Path-like, optional</span>
<span class="sd">            A location to write out generated python and numba code. If not</span>
<span class="sd">            provided, a unique temporary directory is created.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of this Flow used for writing out cached files. If not</span>
<span class="sd">            provided, a unique name is generated. If `cache_dir` is given,</span>
<span class="sd">            be sure to avoid name conflicts with other flow&#39;s in the same</span>
<span class="sd">            directory.</span>
<span class="sd">        dtype : str, default &quot;float32&quot;</span>
<span class="sd">            The name of the numpy dtype that will be used for the output.</span>
<span class="sd">        boundscheck : bool, default False</span>
<span class="sd">            If True, boundscheck enables bounds checking for array indices, and</span>
<span class="sd">            out of bounds accesses will raise IndexError. The default is to not</span>
<span class="sd">            do bounds checking, which is faster but can produce garbage results</span>
<span class="sd">            or segfaults if there are problems, so try turning this on for</span>
<span class="sd">            debugging if you are getting unexplained errors or crashes.</span>
<span class="sd">        error_model : {&#39;numpy&#39;, &#39;python&#39;}, default &#39;numpy&#39;</span>
<span class="sd">            The error_model option controls the divide-by-zero behavior. Setting</span>
<span class="sd">            it to ‘python’ causes divide-by-zero to raise exception like</span>
<span class="sd">            CPython. Setting it to ‘numpy’ causes divide-by-zero to set the</span>
<span class="sd">            result to +/-inf or nan.</span>
<span class="sd">        nopython : bool, default True</span>
<span class="sd">            Compile using numba&#39;s `nopython` mode.  Provided for debugging only,</span>
<span class="sd">            as there&#39;s little point in turning this off for production code, as</span>
<span class="sd">            all the speed benefits of sharrow will be lost.</span>
<span class="sd">        fastmath : bool, default True</span>
<span class="sd">            If true, fastmath enables the use of &quot;fast&quot; floating point transforms,</span>
<span class="sd">            which can improve performance but can result in tiny distortions in</span>
<span class="sd">            results.  See numba docs for details.</span>
<span class="sd">        parallel : bool, default True</span>
<span class="sd">            Enable or disable parallel computation for certain functions.</span>
<span class="sd">        readme : str, optional</span>
<span class="sd">            A string to inject as a comment at the top of the flow Python file.</span>
<span class="sd">        flow_library : Mapping[str,Flow], optional</span>
<span class="sd">            An in-memory cache of precompiled Flow objects.  Using this can result</span>
<span class="sd">            in performance improvements when repeatedly using the same definitions.</span>
<span class="sd">        extra_hash_data : Tuple[Hashable], optional</span>
<span class="sd">            Additional data used for generating the flow hash.  Useful to prevent</span>
<span class="sd">            conflicts when using a flow_library with multiple similar flows.</span>
<span class="sd">        write_hash_audit : bool, default True</span>
<span class="sd">            Writes a hash audit log into a comment in the flow Python file, for</span>
<span class="sd">            debugging purposes.</span>
<span class="sd">        hashing_level : int, default 1</span>
<span class="sd">            Level of detail to write into flow hashes.  Increase detail to avoid</span>
<span class="sd">            hash conflicts for similar flows.  Level 2 adds information about</span>
<span class="sd">            names used in expressions and digital encodings to the flow hash,</span>
<span class="sd">            which prevents conflicts but requires more pre-computation to generate</span>
<span class="sd">            the hash.</span>
<span class="sd">        dim_exclude : Collection[str], optional</span>
<span class="sd">            Exclude these root dataset dimensions from this flow.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Flow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.flows</span> <span class="kn">import</span> <span class="n">Flow</span>

        <span class="k">return</span> <span class="n">Flow</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">definition_spec</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">boundscheck</span><span class="o">=</span><span class="n">boundscheck</span><span class="p">,</span>
            <span class="n">nopython</span><span class="o">=</span><span class="n">nopython</span><span class="p">,</span>
            <span class="n">fastmath</span><span class="o">=</span><span class="n">fastmath</span><span class="p">,</span>
            <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span>
            <span class="n">readme</span><span class="o">=</span><span class="n">readme</span><span class="p">,</span>
            <span class="n">flow_library</span><span class="o">=</span><span class="n">flow_library</span><span class="p">,</span>
            <span class="n">extra_hash_data</span><span class="o">=</span><span class="n">extra_hash_data</span><span class="p">,</span>
            <span class="n">hashing_level</span><span class="o">=</span><span class="n">hashing_level</span><span class="p">,</span>
            <span class="n">error_model</span><span class="o">=</span><span class="n">error_model</span><span class="p">,</span>
            <span class="n">write_hash_audit</span><span class="o">=</span><span class="n">write_hash_audit</span><span class="p">,</span>
            <span class="n">dim_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span>
            <span class="n">dim_exclude</span><span class="o">=</span><span class="n">dim_exclude</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_spill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_name_tokens</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write backup code for sharrow-lite.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        all_name_tokens</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_named_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mangled_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mangled_name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;__&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">mangled_name</span><span class="p">)</span>
        <span class="n">name1</span><span class="p">,</span> <span class="n">name2</span> <span class="o">=</span> <span class="n">mangled_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset</span><span class="p">[</span><span class="n">name2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">_BY_OFFSET</span> <span class="o">=</span> <span class="s2">&quot;digitizedOffset&quot;</span>

<div class="viewcode-block" id="DataTree.digitize_relationships"><a class="viewcode-back" href="../../api/generated/larch.DataTree.digitize_relationships.html#larch.DataTree.digitize_relationships">[docs]</a>    <span class="k">def</span> <span class="nf">digitize_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">redigitize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert all label-based relationships into position-based.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inplace : bool, default False</span>
<span class="sd">        redigitize : bool, default True</span>
<span class="sd">            Re-compute position-based relationships from labels, even</span>
<span class="sd">            if the relationship had previously been digitized.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataTree or None</span>
<span class="sd">            Only returns a copy if not digitizing in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_get_relationship</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">redigitize</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">analog</span><span class="p">:</span>
                <span class="n">p_dataset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_data</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">parent_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_dataset</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">indexing</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">parent_name</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">analog</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">indexing</span> <span class="o">==</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span>
                <span class="n">p_dataset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_data</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">c_dataset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">child_data</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="n">upstream</span> <span class="o">=</span> <span class="n">p_dataset</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_name</span><span class="p">]</span>
                <span class="n">downstream</span> <span class="o">=</span> <span class="n">c_dataset</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">child_name</span><span class="p">]</span>

                <span class="c1"># vectorize version</span>
                <span class="n">mapper</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">j</span> <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">downstream</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())}</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">get</span><span class="p">),</span> <span class="n">upstream</span><span class="p">)</span>

                <span class="c1"># candidate name for write back</span>
                <span class="n">r_parent_name_new</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_BY_OFFSET</span><span class="si">}{</span><span class="n">r</span><span class="o">.</span><span class="n">parent_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">child_data</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">child_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="c1"># it is common to have mirrored offsets in various dimensions.</span>
                <span class="c1"># we&#39;d like to retain only the same data in memory once, so we&#39;ll</span>
                <span class="c1"># check if these offsets match any existing ones and if so just</span>
                <span class="c1"># point to that memory.</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p_dataset</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_BY_OFFSET</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">p_dataset</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">offsets</span><span class="p">):</span>
                            <span class="c1"># we found a match, so we&#39;ll assign this name to</span>
                            <span class="c1"># the match&#39;s memory storage instead of replicating it.</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_data</span><span class="p">][</span>
                                <span class="s2">&quot;dataset&quot;</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">p_dataset</span><span class="o">.</span><span class="n">assign</span><span class="p">({</span><span class="n">r_parent_name_new</span><span class="p">:</span> <span class="n">p_dataset</span><span class="p">[</span><span class="n">k</span><span class="p">]})</span>
                            <span class="c1"># r_parent_name_new = k</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># no existing offset arrays match, make this new one</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">parent_data</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_dataset</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">r_parent_name_new</span><span class="p">:</span> <span class="n">offsets</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">parent_name</span><span class="o">=</span><span class="n">r_parent_name_new</span><span class="p">,</span>
                        <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
                        <span class="n">analog</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">parent_name</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">relationships_are_digitized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool : Whether all relationships are digital (by position).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relationship</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">indexing</span> <span class="o">!=</span> <span class="s2">&quot;position&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_arg_tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spacename</span><span class="p">,</span> <span class="n">spacearray</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">spacename</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">:</span>
            <span class="n">root_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span>
            <span class="kn">from</span> <span class="nn">.flows</span> <span class="kn">import</span> <span class="n">presorted</span>

            <span class="n">root_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">presorted</span><span class="p">(</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spacearray</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">from_dims</span> <span class="o">=</span> <span class="n">root_dataset</span><span class="p">[</span><span class="n">spacearray</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">from_dims</span> <span class="o">=</span> <span class="n">spacearray</span><span class="o">.</span><span class="n">dims</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_arg</span><span class="si">{</span><span class="n">root_dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">from_dims</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spacearray</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">from_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">spacename</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="n">spacearray</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">from_dims</span> <span class="o">=</span> <span class="n">spacearray</span><span class="o">.</span><span class="n">dims</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">dimname</span> <span class="ow">in</span> <span class="n">from_dims</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">spacename</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">this_dim_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s2">&quot;child_name&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dimname</span> <span class="o">!=</span> <span class="n">this_dim_name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">parent_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s2">&quot;parent_name&quot;</span><span class="p">]</span>
                <span class="n">parent_data</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">upside_ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg_tokenizer</span><span class="p">(</span>
                    <span class="n">parent_data</span><span class="p">,</span> <span class="n">parent_name</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="o">=</span><span class="n">exclude_dims</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">upside</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">upside_ast</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">upside_ast</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t:</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">parent_data</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">parent_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">upside</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">coords</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">__shallow_copy_extras</span><span class="p">()</span>
        <span class="p">)</span>
</pre></div>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Jeffrey Newman<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>